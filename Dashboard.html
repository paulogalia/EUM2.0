<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    /* --- CSS GERAL (PREMIUM) --- */
    :root {
      --primary: #2563eb; --primary-dark: #1e40af; --accent: #3b82f6;
      --bg: #f8fafc; --surface: #ffffff; --text: #0f172a; --text-light: #64748b;
      --border: #e2e8f0; --success: #10b981; --locked: #94a3b8; --warning: #f59e0b;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
    }

    body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
    
    /* --- HEADER --- */
    header { 
      background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(226, 232, 240, 0.8); 
      padding: 0 40px; height: 70px; display: flex; justify-content: space-between; align-items: center; z-index: 100; 
      opacity: 0; transition: opacity 1s; /* Escondido no in√≠cio */
    }
    body.loaded header { opacity: 1; } /* Mostra quando carregado */

    .logo { 
      font-weight: 800; font-size: 1.3rem; 
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); 
      -webkit-background-clip: text; -webkit-text-fill-color: transparent; 
      display: flex; align-items: center; gap: 10px; letter-spacing: -0.03em; 
    }
    
    /* Navega√ß√£o "Pill" */
    nav { display: flex; gap: 6px; background-color: #f1f5f9; padding: 5px; border-radius: 12px; border: 1px solid #e2e8f0; }
    .nav-btn { 
      background: transparent; border: none; padding: 8px 20px; cursor: pointer; 
      font-family: 'Inter', sans-serif; font-weight: 600; font-size: 0.9rem; color: #64748b; 
      border-radius: 8px; transition: all 0.2s ease; display: flex; align-items: center; gap: 8px; 
    }
    .nav-btn span:not(.lock) { font-size: 1.1em; opacity: 0.8; }
    .nav-btn.active { background-color: #ffffff; color: var(--primary); box-shadow: 0 1px 3px rgba(0,0,0,0.05); font-weight: 700; }
    .nav-btn:hover:not([disabled]) { color: var(--text); background: rgba(255, 255, 255, 0.6); }
    .nav-btn[disabled] { cursor: not-allowed; opacity: 0.4; filter: grayscale(100%); }
    .lock { font-size: 0.75em; margin-left: 4px; opacity: 0.7; }

    /* --- MAIN CONTENT --- */
    main { flex: 1; overflow: hidden; position: relative; opacity: 0; transition: opacity 1s; }
    body.loaded main { opacity: 1; }
    
    .view-section { display: none; width: 100%; height: 100%; overflow-y: auto; padding: 30px; box-sizing: border-box; animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
    .view-section.active { display: block; }

    /* --- HOME PAGE --- */
    #view-home { padding: 0; }
    .hero-section { min-height: 70vh; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); color: white; position: relative; overflow: hidden; }
    .hero-bg { position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: radial-gradient(circle at 50% 50%, rgba(37, 99, 235, 0.15), transparent 50%), radial-gradient(circle at 80% 20%, rgba(236, 72, 153, 0.15), transparent 40%); animation: rotateBg 20s linear infinite; z-index: 0; pointer-events: none; }
    .hero-content { position: relative; z-index: 2; max-width: 800px; padding: 20px; }
    .hero-title { font-size: 3.5rem; font-weight: 800; margin-bottom: 20px; background: linear-gradient(to right, #fff, #94a3b8); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .hero-subtitle { font-size: 1.2rem; color: #cbd5e1; margin-bottom: 40px; line-height: 1.6; }
    .hero-btn { padding: 16px 40px; font-size: 1.1rem; font-weight: 700; color: white; background: linear-gradient(135deg, var(--primary), #ec4899); border: none; border-radius: 50px; cursor: pointer; box-shadow: 0 10px 30px rgba(37,99,235,0.4); transition: transform 0.2s; }
    .hero-btn:hover { transform: scale(1.05); }

    .info-section { padding: 60px 40px; background: white; display: grid; grid-template-columns: 1fr 1fr; gap: 60px; align-items: center; max-width: 1200px; margin: 0 auto; }
    .info-text h2 { font-size: 2rem; color: #1e293b; margin-bottom: 20px; }
    .info-text p { font-size: 1.05rem; color: #475569; line-height: 1.7; margin-bottom: 15px; }
    .glass-card { background: rgba(255,255,255,0.8); border: 1px solid #e2e8f0; padding: 20px; border-radius: 12px; box-shadow: var(--shadow-md); margin-bottom: 15px; border-left: 4px solid var(--primary); transition: transform 0.2s; }
    .glass-card:hover { transform: translateY(-3px); }
    .glass-card h3 { margin: 0 0 5px 0; color: #1e293b; font-size: 1.1rem; } 
    .glass-card p { margin: 0; color: #64748b; font-size: 0.9rem; }

    /* --- CONFIG & MODULES --- */
    .config-container { display: grid; grid-template-columns: 1fr 320px; gap: 25px; max-width: 1200px; margin: 0 auto; }
    .config-main { background: var(--surface); padding: 30px; border-radius: 16px; border: 1px solid var(--border); box-shadow: var(--shadow-sm); }
    .config-sidebar { display: flex; flex-direction: column; gap: 20px; }
    
    h2 { margin-top: 0; color: #111827; font-size: 1.6rem; }
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
    .form-group label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 8px; color: #4b5563; }
    select, input { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; background: #f9fafb; transition: border 0.2s; box-sizing: border-box; }

    .module-card { border: 1px solid var(--border); border-radius: 12px; margin-top: 20px; background: #fff; overflow: hidden; transition: 0.3s; }
    .module-header { padding: 15px 20px; background: #f8fafc; display: flex; justify-content: space-between; align-items: center; cursor: pointer; user-select: none; }
    .module-title { font-weight: 600; color: #334155; font-size: 1rem; }
    .toggle-switch { width: 44px; height: 24px; background: #cbd5e1; border-radius: 12px; position: relative; transition: 0.3s; flex-shrink: 0; }
    .toggle-knob { width: 20px; height: 20px; background: white; border-radius: 50%; position: absolute; top: 2px; left: 2px; transition: 0.3s; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .module-card.active { border-color: var(--primary); box-shadow: var(--shadow-md); }
    .module-card.active .module-header { background: #eff6ff; }
    .module-card.active .toggle-switch { background: var(--primary); }
    .module-card.active .toggle-knob { transform: translateX(20px); }
    .module-card.mandatory .module-header { cursor: default; }
    .module-card.mandatory .toggle-switch { background: var(--primary); opacity: 0.5; cursor: not-allowed; }
    .module-card.mandatory .toggle-knob { transform: translateX(20px); }
    .module-body { max-height: 0; overflow: hidden; transition: max-height 0.4s ease, padding 0.4s; }
    .module-card.active .module-body, .module-card.mandatory .module-body { max-height: 1000px; opacity: 1; padding: 20px; border-top: 1px solid #e2e8f0; }
    .hidden-form { display: block; }

    .status-card { background: var(--surface); padding: 20px; border-radius: 16px; border: 1px solid var(--border); }
    .status-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem; color: #475569; font-weight: 500; }
    .badge { padding: 4px 10px; border-radius: 6px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; }
    .badge.pending { background: #f1f5f9; color: #94a3b8; }
    .badge.ready { background: #dcfce7; color: #166534; }

    .btn-save { background: var(--primary); color: white; padding: 14px; border-radius: 8px; font-weight: 600; width: 100%; border: none; cursor: pointer; font-size: 1rem; transition: 0.2s; box-shadow: var(--shadow-lg); display: flex; justify-content: center; align-items: center; gap: 8px; }
    .actions-row { display: flex; gap: 10px; margin-bottom: 20px; width: 100%; }
    .btn-outline { flex: 1; background: #fff; border: 1px solid #d1d5db; color: #475569; padding: 10px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 0.85rem; transition: 0.2s; display: flex; justify-content: center; align-items: center; gap: 5px; }
    .btn-outline:hover { border-color: var(--primary); color: var(--primary); background: #eff6ff; }

    /* Chart Containers */
    .control-bar { display: flex; gap: 15px; padding: 20px; background: #fff; border-radius: 12px; border: 1px solid #e5e7eb; margin-bottom: 25px; align-items: center; max-width: 1400px; margin: 0 auto 25px auto; box-shadow: var(--shadow-sm); }
    .chart-box { height: 500px; background: #fff; border-radius: 12px; border: 1px solid #e5e7eb; padding: 15px; box-shadow: var(--shadow-sm); }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes rotateBg { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>

<?!= include('SplashScreen'); ?>

<header>
  <div class="logo"><span>üöÄ</span> EUM Manager</div>
  <nav>
    <button class="nav-btn active" onclick="switchView('home', this)"><span>üè†</span> In√≠cio</button>
    <button class="nav-btn" onclick="switchView('config', this)"><span>‚öôÔ∏è</span> Configura√ß√£o</button>
    <div style="width:1px; height:24px; background:#cbd5e1; margin:0 5px;"></div>
    <button class="nav-btn" id="nav-perfil" onclick="switchView('perfil', this)" disabled><span>üë•</span> Perfil <span class="lock">üîí</span></button>
    <button class="nav-btn" id="nav-eficacia" onclick="switchView('eficacia', this)" disabled><span>üß™</span> Efic√°cia <span class="lock">üîí</span></button>
    <button class="nav-btn" id="nav-seguranca" onclick="switchView('seguranca', this)" disabled><span>üõ°Ô∏è</span> Seguran√ßa <span class="lock">üîí</span></button>
  </nav>
</header>

<main>
  <section id="view-home" class="view-section active">
    <div class="hero-section">
      <div class="hero-bg"></div>
      <div class="hero-content">
        <h1 class="hero-title">Intelig√™ncia Cl√≠nica<br>em Tempo Real</h1>
        <p class="hero-subtitle">O sistema definitivo para Estudos de Utiliza√ß√£o de Medicamentos.</p>
        <button class="hero-btn" onclick="goToConfig()">Iniciar Configura√ß√£o ‚Üí</button>
      </div>
    </div>
    <div class="info-section">
      <div class="info-text">
        <h2>O que √© um EUM?</h2>
        <p>O Estudo de Utiliza√ß√£o de Medicamentos (EUM) √© uma ferramenta para compreender o padr√£o de uso terap√™utico, identificar desvios e monitorizar a seguran√ßa.</p>
        <p>Este sistema transforma dados brutos em evid√™ncia cl√≠nica visual.</p>
      </div>
      <div class="info-cards">
        <div class="glass-card"><h3>üë• Perfil</h3><p>An√°lise demogr√°fica.</p></div>
        <div class="glass-card" style="border-left-color:#10b981;"><h3>üß™ Efic√°cia</h3><p>Tend√™ncia com refer√™ncias.</p></div>
        <div class="glass-card" style="border-left-color:#ef4444;"><h3>üõ°Ô∏è Seguran√ßa</h3><p>Farmacovigil√¢ncia avan√ßada.</p></div>
      </div>
    </div>
  </section>

  <section id="view-config" class="view-section">
    <div class="config-container">
      <div class="config-main">
        <h2>Configura√ß√£o de Dados</h2>
        <p style="color:#64748b; margin-bottom:30px;">Mapeie as abas.</p>
        
        <div class="module-card mandatory active" id="card-core">
          <div class="module-header">
            <div class="module-title">1. N√∫cleo <span style="font-size:0.7rem; background:#e2e8f0; padding:2px 8px; border-radius:10px; margin-left:10px;">Obrigat√≥rio</span></div>
            <div class="toggle-switch"><div class="toggle-knob" style="transform:translateX(20px)"></div></div>
          </div>
          <div class="module-body">
            <div class="form-grid"><div class="form-group"><label>Aba Eventos</label><select id="cfg-core-aba-fatos" onchange="loadCols(this.value, 'core-fatos')"></select></div><div class="form-group"><label>Aba Pacientes</label><select id="cfg-core-aba-dim" onchange="loadCols(this.value, 'core-dim')"></select></div></div>
            <div class="form-grid"><div class="form-group"><label>Prontu√°rio (Fatos)</label><select id="cfg-core-col-pront-fatos" class="col-core-fatos"></select></div><div class="form-group"><label>Medicamento</label><select id="cfg-core-col-med" class="col-core-fatos"></select></div><div class="form-group"><label>Data In√≠cio</label><select id="cfg-core-col-dt" class="col-core-fatos"></select></div></div>
            <div class="form-grid"><div class="form-group"><label>Prontu√°rio (Pacientes)</label><select id="cfg-core-col-pront-dim" class="col-core-dim"></select></div><div class="form-group"><label>Nascimento</label><select id="cfg-core-col-nasc" class="col-core-dim"></select></div><div class="form-group"><label>Sexo</label><select id="cfg-core-col-sexo" class="col-core-dim"></select></div></div>
          </div>
        </div>

        <div class="module-card" id="card-exames">
          <div class="module-header" onclick="toggleModule('exames')">
            <div class="module-title">üß™ 2. Extens√£o: Exames</div>
            <div class="toggle-switch"><div class="toggle-knob"></div></div>
          </div>
          <div class="module-body hidden-form" id="form-exames">
            <div class="actions-row">
              <button class="btn-outline" onclick="importarRef(this)"><span>üì•</span> Importar Regras</button>
              <button class="btn-outline" onclick="processarExames(this)"><span>‚öôÔ∏è</span> Processar An√°lise</button>
            </div>
            <div class="form-group"><label>Aba Exames</label><select id="cfg-ex-aba" onchange="loadCols(this.value, 'exames')"></select></div>
            <div class="form-grid"><div class="form-group"><label>Prontu√°rio</label><select id="cfg-ex-col-pront" class="col-exames"></select></div><div class="form-group"><label>Nome Exame</label><select id="cfg-ex-col-nome" class="col-exames"></select></div><div class="form-group"><label>Valor</label><select id="cfg-ex-col-valor" class="col-exames"></select></div><div class="form-group"><label>Data</label><select id="cfg-ex-col-data" class="col-exames"></select></div></div>
          </div>
        </div>

        <div class="module-card" id="card-rams">
          <div class="module-header" onclick="toggleModule('rams')">
            <div class="module-title">üõ°Ô∏è 3. Extens√£o: Seguran√ßa</div>
            <div class="toggle-switch"><div class="toggle-knob"></div></div>
          </div>
          <div class="module-body hidden-form" id="form-rams">
             <div class="form-group"><label>Aba RAMs</label><select id="cfg-ram-aba" onchange="loadCols(this.value, 'rams')"></select></div>
             <div class="form-grid"><div class="form-group"><label>Gravidade</label><select id="cfg-ram-col-grav" class="col-rams"></select></div><div class="form-group"><label>Causalidade</label><select id="cfg-ram-col-caus" class="col-rams"></select></div></div>
          </div>
        </div>
      </div>

      <div class="config-sidebar">
        <div class="status-card">
          <h4>Estado do Sistema</h4>
          <div class="status-item"><span>N√∫cleo</span><span class="badge pending" id="st-core">Pendente</span></div>
          <div class="status-item"><span>Exames</span><span class="badge pending" id="st-exames">Inativo</span></div>
          <div class="status-item"><span>RAMs</span><span class="badge pending" id="st-rams">Inativo</span></div>
        </div>
        <button class="btn-save" onclick="saveCfg()"><span>üíæ</span> Salvar e Validar</button>
      </div>
    </div>
  </section>

  <section id="view-perfil" class="view-section">
    <h2>Perfil Demogr√°fico</h2>
    <div class="control-bar">
      <div style="flex:1"><label style="font-size:0.8rem;font-weight:bold;color:#64748b">MEDICAMENTO</label><select id="perf-med" style="width:100%;margin-top:5px"><option>Selecione...</option></select></div>
      <button class="btn-save" style="width:auto; padding:10px 25px;" onclick="renderPerfil()">üìä Analisar</button>
    </div>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;"><div class="chart-box" id="chart-perfil-sexo"></div><div class="chart-box" id="chart-perfil-idade"></div></div>
  </section>

  <?!= include('LabEficacia'); ?>

  <section id="view-seguranca" class="view-section">
    <h2>Matriz de Risco</h2>
    <div class="control-bar">
      <div style="flex:1; font-size:0.9rem; color:#64748b;">Visualiza√ß√£o de Gravidade vs. Causalidade</div>
      <button class="btn-save" style="width:auto; padding:10px 25px;" onclick="renderSeguranca()">üõ°Ô∏è Atualizar</button>
    </div>
    <div class="chart-box" id="chart-seguranca" style="max-width:1200px; margin:0 auto;"></div>
  </section>

</main>

<script>
  let globalConfig = {};

  // 1. INICIA A SEQU√äNCIA DE LAN√áAMENTO (SPLASH)
  window.onload = function() {
    // Verifica se a fun√ß√£o do ficheiro SplashScreen.html existe
    if (typeof startSplashSequence === 'function') {
      // Inicia anima√ß√£o e passa a fun√ß√£o que ser√° chamada quando o bot√£o for clicado e o foguete voar
      startSplashSequence(function() {
        document.body.classList.add('loaded'); // Mostra o Dashboard real
      });
    } else {
      // Fallback se algo falhar
      document.body.classList.add('loaded');
    }

    // 2. Carrega os dados em paralelo
    google.script.run.withSuccessHandler(initApp).apiGetInitialState();
  };

  function initApp(state) {
    if(!state) return;
    globalConfig = state.config;
    ['cfg-core-aba-fatos', 'cfg-core-aba-dim', 'cfg-ex-aba', 'cfg-ram-aba'].forEach(id => {
      const el = document.getElementById(id); if(el) { el.innerHTML = '<option value="">-- Selecione --</option>'; state.sheets.forEach(s => el.innerHTML += `<option value="${s}">${s}</option>`); }
    });
    
    if(state.config.core) {
      const c = state.config.core;
      setVal('cfg-core-aba-fatos', c.abaFatos); setVal('cfg-core-aba-dim', c.abaDim);
      lc(c.abaFatos,'core-fatos',()=> { setVal('cfg-core-col-pront-fatos', c.colProntFatos); setVal('cfg-core-col-med', c.colMed); setVal('cfg-core-col-dt', c.colDtIni); });
      lc(c.abaDim,'core-dim',()=> { setVal('cfg-core-col-pront-dim', c.colProntDim); setVal('cfg-core-col-nasc', c.colNasc); setVal('cfg-core-col-sexo', c.colSexo); });
    }
    if(state.config.exames?.active) {
      toggleModule('exames',true); const e=state.config.exames; setVal('cfg-ex-aba', e.aba);
      lc(e.aba,'exames',()=> { setVal('cfg-ex-col-pront', e.colPront); setVal('cfg-ex-col-nome', e.colNome); setVal('cfg-ex-col-valor', e.colValor); setVal('cfg-ex-col-data', e.colData); });
    }
    if(state.config.rams?.active) {
      toggleModule('rams',true); const r=state.config.rams; setVal('cfg-ram-aba', r.aba);
      lc(r.aba,'rams',()=> { setVal('cfg-ram-col-grav', r.colGrav); setVal('cfg-ram-col-caus', r.colCaus); });
    }
    updStat(state.status);
  }

  function setVal(id, v){ if(v) document.getElementById(id).value=v; }
  function lc(s,c,cb){ if(!s)return; google.script.run.withSuccessHandler(l=>{ document.querySelectorAll('.'+c).forEach(e=>{ const old=e.value; e.innerHTML='<option value="">-- Selecione --</option>'; l.forEach(x=>e.innerHTML+=`<option value="${x}">${x}</option>`); if(old)e.value=old; }); if(cb)cb(); }).apiGetColumns(s); }
  
  function toggleModule(m, f) { 
    const d=document.getElementById('card-'+m); 
    if(f===true) d.classList.add('active'); else if(f===false) d.classList.remove('active'); else d.classList.toggle('active');
  }

  function saveCfg() {
    const af=document.getElementById('cfg-core-aba-fatos').value, ad=document.getElementById('cfg-core-aba-dim').value;
    if(!af||!ad) return alert("N√∫cleo Obrigat√≥rio");
    const cfg={
      core: { abaFatos:af, abaDim:ad, colProntFatos:document.getElementById('cfg-core-col-pront-fatos').value, colMed:document.getElementById('cfg-core-col-med').value, colDtIni:document.getElementById('cfg-core-col-dt').value, colProntDim:document.getElementById('cfg-core-col-pront-dim').value, colNasc:document.getElementById('cfg-core-col-nasc').value, colSexo:document.getElementById('cfg-core-col-sexo').value },
      exames: { active:document.getElementById('card-exames').classList.contains('active'), aba:document.getElementById('cfg-ex-aba').value, colPront:document.getElementById('cfg-ex-col-pront').value, colNome:document.getElementById('cfg-ex-col-nome').value, colValor:document.getElementById('cfg-ex-col-valor').value, colData:document.getElementById('cfg-ex-col-data').value },
      rams: { active:document.getElementById('card-rams').classList.contains('active'), aba:document.getElementById('cfg-ram-aba').value, colGrav:document.getElementById('cfg-ram-col-grav').value, colCaus:document.getElementById('cfg-ram-col-caus').value }
    };
    const btn=document.querySelector('.config-sidebar .btn-save'); btn.innerHTML="<span>‚è≥</span> Salvando..."; btn.disabled=true;
    google.script.run.withSuccessHandler(r=>{
      btn.innerHTML="<span>üíæ</span> Salvar e Validar"; btn.disabled=false;
      if(r.sucesso){ globalConfig=cfg; updStat(r.status); alert("Salvo!"); } else alert(r.erro);
    }).apiSaveConfig(cfg);
  }

  function updStat(s) {
    const b=(id,on)=>{ const e=document.getElementById(id); e.className=on?'badge ready':'badge pending'; e.innerText=on?'ATIVO':'PENDENTE'; };
    b('st-core',s.hasCore); b('st-exames',s.hasExames); b('st-rams',s.hasRams);
    const l=(id,on)=>{ const e=document.getElementById('nav-'+id); e.disabled=!on; e.querySelector('.lock').style.display=on?'none':'inline'; };
    l('perfil',s.hasCore); l('eficacia',s.hasExames&&s.hasCore); l('seguranca',s.hasRams);
  }

  function importarRef(btn) { btn.innerText="..."; btn.disabled=true; google.script.run.withSuccessHandler(res => { btn.innerText="üì• Importar"; btn.disabled=false; alert(res.msg||res.erro); }).apiImportarReferencias(); }
  function processarExames(btn) { btn.innerText="..."; btn.disabled=true; google.script.run.withSuccessHandler(res => { btn.innerText="‚öôÔ∏è Processar"; btn.disabled=false; alert(res.msg||res.erro); }).apiProcessarAnaliseExames(); }

  function switchView(v, b) {
    if(v==='home') document.querySelector('main').scrollTop = 0;
    document.querySelectorAll('.view-section').forEach(e=>e.classList.remove('active'));
    document.getElementById('view-'+v).classList.add('active');
    document.querySelectorAll('.nav-btn').forEach(e=>e.classList.remove('active'));
    if(b) b.classList.add('active');
    if(v==='config') goToConfig();
    if(v==='perfil'||v==='eficacia') prepareFilters(v);
    if(v==='eficacia' && typeof initEficaciaModule === 'function') initEficaciaModule(globalConfig);
    setTimeout(()=>window.dispatchEvent(new Event('resize')),200);
  }
  function goToConfig() { document.getElementById('view-home').classList.remove('active'); document.getElementById('view-config').classList.add('active'); document.querySelectorAll('.nav-btn')[1].classList.add('active'); }
  
  function prepareFilters(v) {
    const c=globalConfig.core; if(!c)return;
    google.script.run.withSuccessHandler(l=>{ const s=document.getElementById('perf-med'); s.innerHTML=''; l.forEach(m=>s.innerHTML+=`<option value="${m}">${m}</option>`); }).apiGetMedicamentos(c.abaFatos, c.colMed);
  }
  function renderPerfil(){ /* ...igual v14... */ }
  function renderSeguranca(){ /* ...igual v14... */ }
</script>
</body>
</html>
