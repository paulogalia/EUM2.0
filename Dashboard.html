<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    /* --- CSS GERAL --- */
    :root {
      --primary: #2563eb; 
      --primary-dark: #1e40af; 
      --accent: #3b82f6;
      --bg: #f8fafc; 
      --surface: #ffffff; 
      --text: #0f172a; 
      --text-light: #64748b;
      --border: #e2e8f0; 
      --success: #10b981; 
      --locked: #94a3b8; 
      --warning: #f59e0b;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
    }

    body { 
      font-family: 'Inter', sans-serif; 
      background: var(--bg); 
      color: var(--text); 
      margin: 0; 
      display: flex; 
      flex-direction: column; 
      height: 100vh; 
      overflow: hidden; 
    }
    
    /* --- HEADER --- */
    header { 
      background: rgba(255, 255, 255, 0.95); 
      backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(226, 232, 240, 0.8); 
      padding-left: 80px; 
      padding-right: 40px; 
      height: 70px; 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      z-index: 100; 
      opacity: 0; 
      transition: opacity 1s;
    }
    body.loaded header { opacity: 1; }

    .brand-area { display: flex; align-items: center; gap: 15px; }
    
    .logo { 
      font-weight: 800; 
      font-size: 1.3rem; 
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); 
      -webkit-background-clip: text; 
      -webkit-text-fill-color: transparent; 
      letter-spacing: -0.03em; 
    }

    /* Badge do Nome do Estudo */
    .study-badge {
      background: #eff6ff; 
      color: #1e40af; 
      padding: 6px 12px; 
      border-radius: 20px;
      font-size: 0.85rem; 
      font-weight: 600; 
      border: 1px solid #bfdbfe;
      display: flex; 
      align-items: center; 
      gap: 6px;
      animation: slideInLeft 0.5s ease-out;
    }
    @keyframes slideInLeft { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
    
    nav { 
      display: flex; 
      gap: 6px; 
      background-color: #f1f5f9; 
      padding: 5px; 
      border-radius: 12px; 
      border: 1px solid #e2e8f0; 
    }
    
    .nav-btn { 
      background: transparent; 
      border: none; 
      padding: 8px 16px; 
      cursor: pointer; 
      font-family: 'Inter', sans-serif; 
      font-weight: 600; 
      font-size: 0.85rem; 
      color: #64748b; 
      border-radius: 8px; 
      transition: all 0.2s ease; 
      display: flex; 
      align-items: center; 
      gap: 6px; 
    }
    .nav-btn.active { background-color: #ffffff; color: var(--primary); box-shadow: 0 1px 3px rgba(0,0,0,0.05); font-weight: 700; }
    .nav-btn:hover:not([disabled]) { color: var(--text); background: rgba(255, 255, 255, 0.6); }
    .nav-btn[disabled] { cursor: not-allowed; opacity: 0.4; filter: grayscale(100%); }
    .lock { font-size: 0.75em; margin-left: 4px; opacity: 0.7; }

    /* --- MAIN CONTENT --- */
    main { flex: 1; overflow: hidden; position: relative; opacity: 0; transition: opacity 1s; }
    body.loaded main { opacity: 1; }
    
    .view-section { display: none; width: 100%; height: 100%; overflow-y: auto; padding: 30px; box-sizing: border-box; animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
    .view-section.active { display: block; }

    /* --- HOME PAGE --- */
    #view-home { padding: 0; }
    .hero-section { min-height: 70vh; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); color: white; position: relative; overflow: hidden; }
    .hero-bg { position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: radial-gradient(circle at 50% 50%, rgba(37, 99, 235, 0.15), transparent 50%), radial-gradient(circle at 80% 20%, rgba(236, 72, 153, 0.15), transparent 40%); animation: rotateBg 20s linear infinite; z-index: 0; pointer-events: none; }
    .hero-content { position: relative; z-index: 2; max-width: 800px; padding: 20px; }
    .hero-title { font-size: 3.5rem; font-weight: 800; margin-bottom: 20px; background: linear-gradient(to right, #fff, #94a3b8); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .hero-subtitle { font-size: 1.2rem; color: #cbd5e1; margin-bottom: 40px; line-height: 1.6; }
    .hero-btn { padding: 16px 40px; font-size: 1.1rem; font-weight: 700; color: white; background: linear-gradient(135deg, var(--primary), #ec4899); border: none; border-radius: 50px; cursor: pointer; box-shadow: 0 10px 30px rgba(37,99,235,0.4); transition: transform 0.2s; }
    .hero-btn:hover { transform: scale(1.05); }

    .info-section { padding: 60px 40px; background: white; display: grid; grid-template-columns: 1fr 1fr; gap: 60px; align-items: center; max-width: 1200px; margin: 0 auto; }
    .info-text h2 { font-size: 2rem; color: #1e293b; margin-bottom: 20px; }
    .info-text p { font-size: 1.05rem; color: #475569; line-height: 1.7; margin-bottom: 15px; }
    .glass-card { background: rgba(255,255,255,0.8); border: 1px solid #e2e8f0; padding: 20px; border-radius: 12px; box-shadow: var(--shadow-md); margin-bottom: 15px; border-left: 4px solid var(--primary); transition: transform 0.2s; }
    .glass-card:hover { transform: translateY(-3px); }
    .glass-card h3 { margin: 0 0 5px 0; color: #1e293b; font-size: 1.1rem; } 
    .glass-card p { margin: 0; color: #64748b; font-size: 0.9rem; }

    /* --- CONFIG & MODULES --- */
    .config-container { display: grid; grid-template-columns: 1fr 320px; gap: 25px; max-width: 1200px; margin: 0 auto; }
    .config-main { background: var(--surface); padding: 30px; border-radius: 16px; border: 1px solid var(--border); }
    .config-sidebar { display: flex; flex-direction: column; gap: 20px; }
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
    .form-group label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 8px; color: #4b5563; }
    select, input { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; background: #f9fafb; transition: border 0.2s; box-sizing: border-box; }
    
    .module-card { border: 1px solid var(--border); border-radius: 12px; margin-top: 20px; background: #fff; overflow: hidden; transition: 0.3s; }
    .module-header { padding: 15px 20px; background: #f8fafc; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
    .module-title { font-weight: 600; color: #334155; font-size: 1rem; }
    .toggle-switch { width: 44px; height: 24px; background: #cbd5e1; border-radius: 12px; position: relative; transition: 0.3s; flex-shrink: 0; }
    .toggle-knob { width: 20px; height: 20px; background: white; border-radius: 50%; position: absolute; top: 2px; left: 2px; transition: 0.3s; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .module-card.active { border-color: var(--primary); box-shadow: var(--shadow-md); }
    .module-card.active .module-header { background: #eff6ff; }
    .module-card.active .toggle-switch { background: var(--primary); }
    .module-card.active .toggle-knob { transform: translateX(20px); }
    .module-card.mandatory .module-header { cursor: default; }
    .module-card.mandatory .toggle-switch { background: var(--primary); opacity: 0.5; cursor: not-allowed; }
    .module-card.mandatory .toggle-knob { transform: translateX(20px); }
    .module-body { max-height: 0; overflow: hidden; transition: max-height 0.4s ease, padding 0.4s; }
    .module-card.active .module-body, .module-card.mandatory .module-body { max-height: 1500px; opacity: 1; padding: 20px; border-top: 1px solid #e2e8f0; }
    .hidden-form { display: block; }
    
    .status-card { background: var(--surface); padding: 20px; border-radius: 16px; border: 1px solid var(--border); }
    .status-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem; color: #475569; font-weight: 500; }
    .badge { padding: 4px 10px; border-radius: 6px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; }
    .badge.pending { background: #f1f5f9; color: #94a3b8; }
    .badge.ready { background: #dcfce7; color: #166534; }
    .btn-save { background: var(--primary); color: white; padding: 14px; border-radius: 8px; font-weight: 600; width: 100%; border: none; cursor: pointer; font-size: 1rem; transition: 0.2s; box-shadow: var(--shadow-lg); display: flex; justify-content: center; align-items: center; gap: 8px; }
    .actions-row { display: flex; gap: 10px; margin-bottom: 20px; width: 100%; }
    .btn-outline { flex: 1; background: #fff; border: 1px solid #d1d5db; color: #475569; padding: 10px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 0.85rem; transition: 0.2s; display: flex; justify-content: center; align-items: center; gap: 5px; }
    .btn-outline:hover { border-color: var(--primary); color: var(--primary); background: #eff6ff; }
    
    .control-bar { display: flex; gap: 15px; padding: 20px; background: #fff; border-radius: 12px; border: 1px solid #e5e7eb; margin-bottom: 25px; align-items: center; max-width: 1400px; margin: 0 auto 25px auto; box-shadow: var(--shadow-sm); }
    .chart-box { height: 500px; background: #fff; border-radius: 12px; border: 1px solid #e5e7eb; padding: 15px; box-shadow: var(--shadow-sm); }

    /* --- WIZARD MODAL --- */
    dialog#wizard-modal {
      padding: 0; border: none; border-radius: 20px;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      max-width: 900px; width: 90%;
      background: linear-gradient(135deg, #f8fafc 0%, #eff6ff 100%);
      animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      overflow: hidden; 
    }
    dialog#wizard-modal::backdrop { background: rgba(15,23,42,0.8); backdrop-filter: blur(4px); }
    @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

    .wiz-content { padding: 40px; overflow-y: auto; max-height: 85vh; }
    .wiz-header { text-align: center; margin-bottom: 30px; }
    .wiz-title { font-size: 1.8rem; font-weight: 800; color: #1e293b; margin-bottom: 5px; }
    .wiz-subtitle { font-size: 1rem; color: #64748b; }

    /* √Årea de IA (Texto) */
    .wiz-ai-box { 
      background: #fff; border: 2px solid #bae6fd; border-radius: 16px; padding: 20px; 
      margin-bottom: 20px; box-shadow: 0 4px 12px rgba(14, 165, 233, 0.1); 
    }
    .wiz-ai-label { font-size: 0.85rem; font-weight: 700; color: #0284c7; display: flex; align-items: center; gap: 6px; margin-bottom: 10px; }
    .wiz-ai-input { 
      width: 100%; padding: 12px; border: 1px solid #e0f2fe; border-radius: 8px; 
      font-size: 1rem; background: #f0f9ff; color: #0c4a6e; box-sizing: border-box;
    }
    .wiz-ai-input:focus { outline: none; border-color: #0284c7; background: #fff; }
    .wiz-ai-btn { 
      background: linear-gradient(135deg, #0ea5e9, #0284c7); color: white; border: none; 
      padding: 0 25px; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 1.2rem; 
    }

    /* √Årea de Upload (Drag & Drop) */
    .wiz-upload-area { 
      border: 2px dashed #cbd5e1; border-radius: 16px; padding: 30px; text-align: center; 
      background: #f8fafc; cursor: pointer; transition: all 0.2s; margin-top: 15px;
    }
    .wiz-upload-area:hover, .wiz-upload-area.dragover { border-color: var(--primary); background: #eff6ff; }
    
    .file-list { margin-top: 15px; display: flex; flex-direction: column; gap: 8px; }
    .file-item { 
      background: #fff; padding: 10px 15px; border: 1px solid #e2e8f0; border-radius: 8px; 
      font-size: 0.9rem; display: flex; justify-content: space-between; align-items: center; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.02); text-align: left;
    }
    .file-remove { color: #ef4444; cursor: pointer; font-weight: bold; padding: 0 5px; }

    /* Relat√≥rio da IA (Visual) */
    .ai-report-card { background: #fff; border: 1px solid #e2e8f0; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
    .report-title { font-size: 0.8rem; font-weight: 700; color: #475569; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px; display: flex; align-items: center; gap: 8px; }
    .report-list { list-style: none; padding: 0; margin: 0; }
    .report-item { display: flex; gap: 10px; align-items: flex-start; font-size: 0.9rem; color: #334155; margin-bottom: 8px; line-height: 1.4; }
    .icon-check { color: #10b981; font-weight: bold; }
    .icon-warn { color: #f59e0b; font-weight: bold; }
    
    .btn-analyze { background: linear-gradient(135deg, #2563eb, #1e40af); color: white; width: 100%; padding: 15px; border-radius: 10px; border: none; font-weight: 700; font-size: 1rem; cursor: pointer; margin-top: 20px; display: none; opacity: 0.6; cursor: not-allowed; }
    .btn-analyze.ready { opacity: 1; cursor: pointer; }
    .wiz-close { position: absolute; top: 20px; right: 20px; background: none; border: none; font-size: 1.5rem; color: #94a3b8; cursor: pointer; }

    /* Cards Manuais */
    .wiz-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; }
    .wiz-card {
      background: #fff; border: 2px solid #e2e8f0; border-radius: 16px; padding: 20px 10px; text-align: center;
      cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden;
    }
    .wiz-card:hover { transform: translateY(-5px); border-color: #3b82f6; box-shadow: 0 10px 30px -10px rgba(59, 130, 246, 0.2); }
    .wiz-icon { font-size: 2rem; margin-bottom: 10px; display: block; }
    .wiz-name { font-size: 0.9rem; font-weight: 700; color: #334155; display: block; }
    .wiz-desc { font-size: 0.75rem; color: #64748b; line-height: 1.3; margin-top: 5px; }
    
    /* Resposta da IA Texto */
    #ai-response-box {
      display: none; background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 12px; 
      padding: 20px; margin-bottom: 30px; animation: slideDown 0.4s ease-out;
    }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    
    .ai-bubble { display: flex; gap: 15px; align-items: flex-start; }
    .ai-avatar { font-size: 2rem; background: #fff; border-radius: 50%; padding: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .ai-text { font-size: 0.95rem; color: #1e3a8a; line-height: 1.5; flex: 1; }
    .ai-strong { font-weight: 700; color: #2563eb; }

    @keyframes rotateBg { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }
    .loading-pulse { animation: pulse 1.5s infinite; }
  </style>
</head>
<body>

<?!= include('SplashScreen'); ?>

<header>
  <div class="brand-area">
    <div class="logo"><span>üöÄ</span> EUM Manager</div>
    <div id="study-badge-container"></div>
  </div>
  
  <nav>
    <button onclick="switchView('home')" class="nav-btn active">üè† In√≠cio</button>
    <button onclick="switchView('config')" class="nav-btn">‚öôÔ∏è Config</button>
    <div style="width:1px; height:24px; background:#cbd5e1; margin:0 5px;"></div>
    <button id="nav-perfil" onclick="switchView('perfil')" class="nav-btn" disabled>üë• Perfil <span class="lock">üîí</span></button>
    <button id="nav-eficacia" onclick="switchView('eficacia')" class="nav-btn" disabled>üß™ Efic√°cia <span class="lock">üîí</span></button>
    <button id="nav-seguranca" onclick="switchView('seguranca')" class="nav-btn" disabled>üõ°Ô∏è Seguran√ßa <span class="lock">üîí</span></button>
    <div style="width:1px; height:24px; background:#cbd5e1; margin:0 5px;"></div>
    <button class="nav-btn" onclick="switchView('explorador')"><span>üß≠</span> Explorador</button>
    <button class="nav-btn" onclick="switchView('fusao')"><span>‚öóÔ∏è</span> Fus√£o</button>
  </nav>
</header>

<main>
  <section id="view-home" class="view-section active">
    <div class="hero-section">
      <h1 class="hero-title">Intelig√™ncia Cl√≠nica</h1>
      <p style="color:#64748b; margin-bottom:40px;">Configure o estudo arrastando seus arquivos.</p>
      <button class="hero-btn" onclick="openWizard()">Iniciar Novo Estudo (IA) ‚ú®</button>
    </div>
  </section>

  <section id="view-config" class="view-section">
    <div class="config-container">
      <div class="config-main">
        <h2>Configura√ß√£o do Estudo</h2>
        <p style="color:#64748b; margin-bottom:30px;">Mapeie as fontes de dados.</p>
        
        <div class="module-card mandatory active" id="card-core">
          <div class="module-header">
            <div class="module-title">1. N√∫cleo & Posologia</div>
          </div>
          
          <div class="module-body">
            <div class="form-grid">
              <div class="form-group"><label>Aba Eventos</label><select id="cfg-core-aba-fatos" onchange="loadCols(this.value, 'core-fatos')"></select></div>
              <div class="form-group"><label>Aba Pacientes</label><select id="cfg-core-aba-dim" onchange="loadCols(this.value, 'core-dim')"></select></div>
            </div>
            
            <div class="form-grid">
              <div class="form-group"><label>Prontu√°rio (Fatos)</label><select id="cfg-core-col-pront-fatos" class="col-core-fatos"></select></div>
              <div class="form-group"><label>Medicamento</label><select id="cfg-core-col-med" class="col-core-fatos"></select></div>
              <div class="form-group"><label>Data In√≠cio</label><select id="cfg-core-col-dt" class="col-core-fatos"></select></div>
            </div>

            <hr style="border:0; border-top:1px solid #f1f5f9; margin:10px 0;">
            <p style="font-size:0.75rem; color:#2563eb; font-weight:700; margin-bottom:10px;">üíä POSOLOGIA</p>

            <div class="form-grid">
              <div class="form-group"><label>Dose Unit√°ria <small>(ex: 500mg)</small></label><select id="cfg-core-col-dose-uni" class="col-core-fatos"></select></div>
              <div class="form-group"><label>Aprazamento <small>(ex: 8/8h)</small></label><select id="cfg-core-col-apraz" class="col-core-fatos"></select></div>
              <div class="form-group"><label>Dose 24h <small>(Total Dia)</small></label><select id="cfg-core-col-dose-24h" class="col-core-fatos"></select></div>
            </div>
            
            <hr style="border:0; border-top:1px solid #f1f5f9; margin:10px 0;">
            <p style="font-size:0.75rem; color:#10b981; font-weight:700; margin-bottom:10px;">üß¨ DADOS CL√çNICOS (RENAL)</p>

            <div class="form-grid">
              <div class="form-group"><label>Peso (kg) <small>(Opcional)</small></label><select id="cfg-core-col-peso" class="col-core-fatos"></select></div>
              <div class="form-group"><label>Altura (cm) <small>(Schwartz)</small></label><select id="cfg-core-col-altura" class="col-core-fatos"></select></div>
              <div class="form-group"><label>Creatinina <small>(mg/dL)</small></label><select id="cfg-core-col-creat" class="col-core-fatos"></select></div>
            </div>

            <hr style="border:0; border-top:1px solid #f1f5f9; margin:10px 0;">

            <div class="form-grid">
              <div class="form-group"><label>Prontu√°rio (Pacientes)</label><select id="cfg-core-col-pront-dim" class="col-core-dim"></select></div>
              <div class="form-group"><label>Nascimento</label><select id="cfg-core-col-nasc" class="col-core-dim"></select></div>
              <div class="form-group"><label>Sexo</label><select id="cfg-core-col-sexo" class="col-core-dim"></select></div>
            </div>
          </div>
        </div>

        <div class="module-card" id="card-exames">
          <div class="module-header" onclick="toggleModule('exames')">
            <div class="module-title">üß™ 2. Extens√£o: Exames</div>
            <div class="toggle-switch"><div class="toggle-knob"></div></div>
          </div>
          <div class="module-body hidden-form" id="form-exames">
            <div class="actions-row">
              <button class="btn-outline" onclick="importarRef(this)"><span>üì•</span> Importar Regras</button>
              <button class="btn-outline" onclick="processarExames(this)"><span>‚öôÔ∏è</span> Processar An√°lise</button>
            </div>
            <div class="form-group"><label>Aba Exames</label><select id="cfg-ex-aba" onchange="loadCols(this.value, 'exames')"></select></div>
            <div class="form-grid"><div class="form-group"><label>Prontu√°rio</label><select id="cfg-ex-col-pront" class="col-exames"></select></div><div class="form-group"><label>Nome Exame</label><select id="cfg-ex-col-nome" class="col-exames"></select></div><div class="form-group"><label>Valor</label><select id="cfg-ex-col-valor" class="col-exames"></select></div><div class="form-group"><label>Data</label><select id="cfg-ex-col-data" class="col-exames"></select></div></div>
          </div>
        </div>

        <div class="module-card" id="card-rams">
          <div class="module-header" onclick="toggleModule('rams')">
            <div class="module-title">üõ°Ô∏è 3. Extens√£o: Seguran√ßa</div>
            <div class="toggle-switch"><div class="toggle-knob"></div></div>
          </div>
          <div class="module-body hidden-form" id="form-rams">
             <div class="form-group"><label>Aba RAMs</label><select id="cfg-ram-aba" onchange="loadCols(this.value, 'rams')"></select></div>
             <div class="form-grid"><div class="form-group"><label>Gravidade</label><select id="cfg-ram-col-grav" class="col-rams"></select></div><div class="form-group"><label>Causalidade</label><select id="cfg-ram-col-caus" class="col-rams"></select></div></div>
          </div>
        </div>
      </div>

      <div class="config-sidebar">
        <div class="status-card">
          <h4>Estado do Sistema</h4>
          <div class="status-item"><span>N√∫cleo</span><span class="badge pending" id="st-core">Pendente</span></div>
          <div class="status-item"><span>Exames</span><span class="badge pending" id="st-exames">Inativo</span></div>
          <div class="status-item"><span>RAMs</span><span class="badge pending" id="st-rams">Inativo</span></div>
        </div>
        
        <div class="status-card" style="margin-top:15px; border-color:#cbd5e1;">
           <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
              <h4 style="margin:0; font-size:0.95rem;">üìö Banco de Exames</h4>
              <span class="badge ready" id="rules-counter" style="background:#eff6ff; color:#1e40af;">Ref.</span>
           </div>
           <p style="font-size:0.8rem; color:#64748b; margin:0 0 10px 0;">Valores de refer√™ncia laboratorial.</p>
           <button class="btn-outline" style="width:100%;" onclick="openRulesModal()">Gerenciar Exames</button>
        </div>

        <div class="status-card" style="margin-top:15px; border-color:#cbd5e1;">
           <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
              <h4 style="margin:0; font-size:0.95rem;">üíä Regras de Dose</h4>
              <span class="badge ready" id="dose-counter" style="background:#fffbeb; color:#b45309;">Dose</span>
           </div>
           <p style="font-size:0.8rem; color:#64748b; margin:0 0 10px 0;">Protocolos de dose usual e m√°xima.</p>
           <button class="btn-outline" style="width:100%;" onclick="openDoseModal()">Gerenciar Doses</button>
        </div>

        <button class="btn-save" onclick="saveCfg()"><span>üíæ</span> Salvar e Validar</button>
      </div>
    </div>
  </section>

  <?!= include('LabEficacia'); ?>
  <?!= include('LabReferencias'); ?>
  <?!= include('LabRegrasDose'); ?>
  <?!= include('LabFusao'); ?>
  <?!= include('LabExplorador'); ?>
  <?!= include('LabSeguranca'); ?>

</main>

<dialog id="wizard-modal">
  <button class="wiz-close" onclick="document.getElementById('wizard-modal').close()">√ó</button>
  <div class="wiz-content">
    <div class="wiz-header">
      <div class="wiz-title">Novo Estudo Inteligente</div>
      <div class="wiz-subtitle">Descreva o estudo OU arraste arquivos para configura√ß√£o autom√°tica.</div>
    </div>
    
    <div class="wiz-ai-box">
      <div class="wiz-ai-label">‚ú® Descreva seu objetivo</div>
      <div style="display:flex; gap:10px;">
        <input type="text" id="ai-intent" class="wiz-ai-input" placeholder="Ex: Analisar doses de Levetiracetam em pacientes renais...">
        <button class="wiz-ai-btn" onclick="askAI()">‚Üí</button>
      </div>
      <div id="ai-loading" style="display:none; color:#0284c7; font-size:0.8rem; margin-top:5px;">ü§ñ Pensando...</div>
    </div>

    <div class="wiz-upload-area" id="drop-zone">
      <div style="font-size:2.5rem;">üìÑ + üìä</div>
      <div style="font-weight:600;">Arraste arquivos aqui</div>
      <div id="file-status-text" style="font-size:0.8rem; color:#64748b;">Aguardando arquivos...</div>
      <input type="file" id="file-input" multiple accept=".pdf,.csv,.xlsx,.xls" style="display:none" onchange="handleFiles(this.files)">
    </div>
    
    <div id="file-list" class="file-list"></div>
    
    <button id="btn-analyze" class="btn-analyze" onclick="runAiAnalysis()">
      ‚ú® Analisar e Configurar
    </button>
    
    <div id="wiz-loading-file" style="display:none; text-align:center; color:#2563eb; margin-top:20px;" class="loading-pulse">
      <span>üß† Lendo PDF e Cruzando com CSV...</span>
    </div>

    <div id="ai-report-area" style="display:none; margin-top:20px;">
      
      <div class="ai-report-card" style="border-left: 4px solid #10b981;">
        <div class="report-title">‚úÖ Capacidades</div>
        <ul class="report-list" id="list-capabilities"></ul>
      </div>

      <div class="ai-report-card" style="border-left: 4px solid #f59e0b;">
        <div class="report-title">‚ö†Ô∏è Pontos de Aten√ß√£o</div>
        <ul class="report-list" id="list-gaps"></ul>
      </div>

      <div style="text-align:center; margin-top:20px;">
        <div id="ai-summary-text" style="color:#64748b; font-size:0.85rem; margin-bottom:15px;"></div>
        <button class="btn-save" onclick="confirmAiMapping()">üöÄ Aplicar Configura√ß√£o</button>
      </div>
    </div>

    <div id="ai-response-box">
      <div class="ai-bubble">
        <div class="ai-avatar">ü§ñ</div>
        <div class="ai-text" id="ai-explanation-text"></div>
      </div>
      <button class="btn-save" style="width:100%; margin-top:15px; padding:10px; background:#2563eb;" onclick="confirmAiPreset()">
        Confirmar Configura√ß√£o
      </button>
    </div>

    <div style="text-align:center; color:#94a3b8; margin:20px 0; font-size:0.7rem; font-weight:bold;">OU SELECIONE MANUALMENTE</div>

    <div class="wiz-input-container"><input type="text" id="manual-name" class="wiz-input" placeholder="Nome do Estudo (Opcional)"></div>

    <div class="wiz-grid">
      <div class="wiz-card" id="card-safety" onclick="applyPreset('safety')"><span class="wiz-icon">üõ°Ô∏è</span><span class="wiz-name">Seguran√ßa</span></div>
      <div class="wiz-card" id="card-efficacy" onclick="applyPreset('efficacy')"><span class="wiz-icon">üß™</span><span class="wiz-name">Efic√°cia</span></div>
      <div class="wiz-card" id="card-protocol" onclick="applyPreset('protocol')"><span class="wiz-icon">üíä</span><span class="wiz-name">Ades√£o</span></div>
      <div class="wiz-card" id="card-full" onclick="applyPreset('full')"><span class="wiz-icon">üöÄ</span><span class="wiz-name">Completo</span></div>
    </div>
  </div>
</dialog>

<script>
  let globalConfig = {};
  let selectedPdf = null, selectedDataMatrix = null, selectedFileName = null;
  let currentAiSuggestion = null, currentMapping = null;

  window.onload = function() {
    if (typeof startSplashSequence === 'function') {
      startSplashSequence((mode) => {
        document.body.classList.add('loaded');
        if (mode === 'new') setTimeout(openWizard, 300);
      });
    } else { document.body.classList.add('loaded'); }
    google.script.run.withSuccessHandler(initApp).apiGetInitialState();
  };

  function initApp(state) {
    if(!state) return;
    globalConfig = state.config;
    
    if(state.config.studyName) {
      document.getElementById('study-badge-container').innerHTML = `<div class="study-badge"><span>üìÇ</span> ${state.config.studyName}</div>`;
    }

    ['cfg-core-aba-fatos', 'cfg-core-aba-dim', 'cfg-ex-aba', 'cfg-ram-aba'].forEach(id => {
      const el = document.getElementById(id); if(el) { el.innerHTML = '<option value="">-- Selecione --</option>'; state.sheets.forEach(s => el.innerHTML += `<option value="${s}">${s}</option>`); }
    });
    
    if(state.config.core) {
      const c = state.config.core;
      setVal('cfg-core-aba-fatos', c.abaFatos); setVal('cfg-core-aba-dim', c.abaDim);
      
      loadCols(c.abaFatos,'core-fatos',()=> { 
          setVal('cfg-core-col-pront-fatos', c.colProntFatos); setVal('cfg-core-col-med', c.colMed); setVal('cfg-core-col-dt', c.colDtIni);
          setVal('cfg-core-col-dose-uni', c.colDoseUni); setVal('cfg-core-col-apraz', c.colApraz); setVal('cfg-core-col-dose-24h', c.colDose24h); 
          setVal('cfg-core-col-peso', c.colPeso); setVal('cfg-core-col-altura', c.colAltura); setVal('cfg-core-col-creat', c.colCreat);
      });
      loadCols(c.abaDim,'core-dim',()=> { setVal('cfg-core-col-pront-dim', c.colProntDim); setVal('cfg-core-col-nasc', c.colNasc); setVal('cfg-core-col-sexo', c.colSexo); });
    }
    if(state.config.exames?.active) { toggleModule('exames',true); const e=state.config.exames; setVal('cfg-ex-aba', e.aba); loadCols(e.aba,'exames',()=> { setVal('cfg-ex-col-pront', e.colPront); setVal('cfg-ex-col-nome', e.colNome); setVal('cfg-ex-col-valor', e.colValor); setVal('cfg-ex-col-data', e.colData); }); }
    if(state.config.rams?.active) { toggleModule('rams',true); const r=state.config.rams; setVal('cfg-ram-aba', r.aba); loadCols(r.aba,'rams',()=> { setVal('cfg-ram-col-grav', r.colGrav); setVal('cfg-ram-col-caus', r.colCaus); }); }
    updStat(state.status);
  }

  function setVal(id, v){ if(v) document.getElementById(id).value=v; }
  function loadCols(s,c,cb){ if(!s)return; google.script.run.withSuccessHandler(l=>{ document.querySelectorAll('.col-'+c).forEach(e=>{ const old=e.value; e.innerHTML='<option value="">-- Selecione --</option>'; l.forEach(x=>e.innerHTML+=`<option value="${x}">${x}</option>`); if(old)e.value=old; }); if(cb)cb(); }).apiGetColumns(s); }
  function toggleModule(m, f) { const d=document.getElementById('card-'+m); if(f===true) d.classList.add('active'); else if(f===false) d.classList.remove('active'); else d.classList.toggle('active'); }
  function switchView(v){ document.querySelectorAll('.view-section').forEach(e=>e.classList.remove('active')); document.getElementById('view-'+v).classList.add('active'); document.querySelectorAll('.nav-btn').forEach(e=>e.classList.remove('active')); event.currentTarget.classList.add('active'); }

  // WIZARD LOGIC
  function openWizard() { 
    document.getElementById('wizard-modal').showModal(); 
    resetWizardUI();
  }
  
  function resetWizardUI() {
    document.getElementById('ai-report-area').style.display='none';
    document.getElementById('ai-response-box').style.display='none';
    document.getElementById('btn-analyze').style.display='none';
    document.getElementById('file-status-text').innerText = "Aguardando arquivos...";
    document.getElementById('file-list').innerHTML = "";
    selectedPdf = null; selectedDataMatrix = null;
  }
  
  // DRAG & DROP
  const dropZone = document.getElementById('drop-zone');
  dropZone.addEventListener('dragover', (e)=>{e.preventDefault(); dropZone.classList.add('dragover');});
  dropZone.addEventListener('drop', (e)=>{e.preventDefault(); handleFiles(e.dataTransfer.files);});
  dropZone.onclick = () => document.getElementById('file-input').click();

  function handleFiles(files) {
    const list = document.getElementById('file-list');
    
    Array.from(files).forEach(f => {
      const name = f.name.toLowerCase();
      
      // PDF
      if(name.endsWith('.pdf')) { 
        // Atualiza UI imediatamente
        list.innerHTML += `<div class="file-item"><span>üìÑ ${f.name}</span><span class="icon-check">‚úî</span></div>`;
        
        const r = new FileReader(); 
        r.onload=e=>selectedPdf=e.target.result.split(',')[1]; 
        r.readAsDataURL(f); 
      }
      // CSV / Excel
      else if(name.match(/\.(csv|xlsx|xls)$/)) {
        // Atualiza UI imediatamente
        list.innerHTML += `<div class="file-item"><span>üìä ${f.name}</span><span class="icon-check">‚úî</span></div>`;
        selectedFileName = f.name;
        
        const r = new FileReader();
        r.onload = (e) => {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, {type: 'array'});
          const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
          // Converte para Matriz (Array de Arrays) para enviar ao Google Script
          selectedDataMatrix = XLSX.utils.sheet_to_json(firstSheet, {header:1});
          
          // Habilita o bot√£o ap√≥s carregar o CSV
          if(selectedPdf && selectedDataMatrix) {
             document.getElementById('btn-analyze').style.display='block';
             document.getElementById('btn-analyze').classList.add('ready');
          }
        };
        r.readAsArrayBuffer(f);
      }
    });
  }

  function runAiAnalysis() {
    if(!selectedPdf || !selectedDataMatrix) return alert("Preciso de PDF e Dados (CSV/Excel).");
    
    // Valida√ß√£o de Tamanho PDF (Opcional, mas bom para UX)
    if(selectedPdf.length > 4000000) { // ~3MB base64
       if(!confirm("O PDF parece grande. A an√°lise pode demorar. Continuar?")) return;
    }

    document.getElementById('wiz-loading-file').style.display='block'; 
    document.getElementById('btn-analyze').disabled=true;
    
    // CHAMA O BACKEND (apiMagicSetup)
    google.script.run.withSuccessHandler(res => {
      document.getElementById('wiz-loading-file').style.display='none';
      document.getElementById('btn-analyze').disabled=false;
      
      if(res.erro) {
         // Se for erro de IA mas importou, avisa
         if(res.erro.includes("aba")) {
             alert("Aten√ß√£o: " + res.erro);
             document.getElementById('wizard-modal').close();
             return;
         }
         return alert(res.erro);
      }
      
      // Resultados da IA
      document.getElementById('study-badge-container').innerHTML = `<div class="study-badge">ü§ñ ${res.studyName}</div>`;
      globalConfig.studyName = res.studyName;
      currentMapping = res.mapping;
      currentMapping.targetSheet = res.createdSheet; // Nome da aba criada no backend

      // Relat√≥rio Visual
      const cap = document.getElementById('list-capabilities'), gap = document.getElementById('list-gaps');
      cap.innerHTML=''; gap.innerHTML='';
      
      if(res.analysis) {
         res.analysis.capabilities.forEach(t => cap.innerHTML+=`<li class="report-item"><span class="icon-check">‚úî</span> ${t}</li>`);
         res.analysis.gaps.forEach(t => gap.innerHTML+=`<li class="report-item"><span class="icon-warn">‚ö†Ô∏è</span> ${t}</li>`);
      } else {
         cap.innerHTML='<li class="report-item">An√°lise conclu√≠da.</li>';
      }
      
      document.getElementById('ai-summary-text').innerText = `${res.studySummary}`;
      document.getElementById('ai-report-area').style.display='block';

    }).apiMagicSetup(selectedPdf, selectedDataMatrix, selectedFileName);
  }

  function confirmAiMapping() {
    document.getElementById('wizard-modal').close();
    switchView('config');
    
    if(currentMapping) {
      const m = currentMapping;
      const aba = m.targetSheet;
      
      // 1. Adiciona a nova aba ao select
      const abaSelect = document.getElementById('cfg-core-aba-fatos');
      const opt = document.createElement('option'); opt.text=aba; opt.value=aba; opt.selected=true; abaSelect.add(opt, 0);
      
      // 2. Carrega as colunas reais da nova aba e aplica as sugest√µes da IA
      loadCols(aba, 'core-fatos', () => {
         const auto = (id, val) => { 
            if(val) { 
                const el=document.getElementById(id); 
                if(el) {
                    // Tenta encontrar a op√ß√£o pelo texto ou valor
                    for(let i=0; i<el.options.length; i++) {
                        if(el.options[i].value === val) {
                            el.selectedIndex = i;
                            return;
                        }
                    }
                    // Se n√£o achou (ex: IA sugeriu nome ligeiramente diferente), cria op√ß√£o "Sugerida"
                    const o = document.createElement('option'); 
                    o.text = val + " (IA)"; 
                    o.value = val; 
                    o.selected = true; 
                    el.add(o);
                } 
            } 
         };

         auto('cfg-core-col-pront-fatos', m.colProntFatos);
         auto('cfg-core-col-med', m.colMed);
         auto('cfg-core-col-dt', m.colDtIni);
         auto('cfg-core-col-dose-uni', m.colDoseUni);
         auto('cfg-core-col-apraz', m.colApraz);
         auto('cfg-core-col-dose-24h', m.colDose24h);
         auto('cfg-core-col-peso', m.colPeso);
         auto('cfg-core-col-altura', m.colAltura);
         auto('cfg-core-col-creat', m.colCreat);
         auto('cfg-core-col-sexo', m.colSexo);
         auto('cfg-core-col-nasc', m.colNasc);
      });
      
      alert("‚ú® Sucesso! Aba '" + aba + "' criada e colunas mapeadas.");
    }
  }

  // --- IA TEXTO ---
  function askAI() {
    const txt = document.getElementById('ai-intent').value;
    if(!txt) return;
    document.getElementById('ai-loading').style.display = 'block';
    document.getElementById('ai-response-box').style.display = 'none';
    
    google.script.run.withSuccessHandler(res => {
      document.getElementById('ai-loading').style.display = 'none';
      if(res.erro) return alert(res.erro);
      
      currentAiSuggestion = res;
      document.getElementById('manual-name').value = res.nome_sugerido;
      
      const box = document.getElementById('ai-response-box');
      const text = document.getElementById('ai-explanation-text');
      text.innerHTML = `${res.explicacao || "Configura√ß√£o pronta."}<br><br><span class="ai-strong">Sugest√£o:</span> Modo ${res.preset.toUpperCase()} (${res.nome_sugerido})`;
      box.style.display = 'block';
    }).apiInterpretarIntencaoEstudo(txt);
  }
  function confirmAiPreset() { if(currentAiSuggestion) applyPreset(currentAiSuggestion.preset); }

  function applyPreset(type) {
    const name = document.getElementById('manual-name').value || "Novo Estudo";
    document.getElementById('wizard-modal').close();
    goToConfig();
    document.getElementById('study-badge-container').innerHTML = `<div class="study-badge"><span>üìÇ</span> ${name}</div>`;
    globalConfig.studyName = name;
    
    toggleModule('exames', false); toggleModule('rams', false);
    if(type==='safety') toggleModule('rams', true);
    else if(type==='efficacy') toggleModule('exames', true);
    else if(type==='full') { toggleModule('exames', true); toggleModule('rams', true); }
  }

  function saveCfg() { 
    const af=document.getElementById('cfg-core-aba-fatos').value, ad=document.getElementById('cfg-core-aba-dim').value;
    if(!af||!ad) return alert("N√∫cleo Obrigat√≥rio");
    const studyName = globalConfig.studyName || document.getElementById('study-badge-container').innerText.replace('üìÇ','').trim();

    const cfg={
      studyName: studyName,
      core: { 
        abaFatos:af, abaDim:ad, 
        colProntFatos:document.getElementById('cfg-core-col-pront-fatos').value, 
        colMed:document.getElementById('cfg-core-col-med').value, 
        colDtIni:document.getElementById('cfg-core-col-dt').value, 
        colDoseUni: document.getElementById('cfg-core-col-dose-uni').value,
        colApraz: document.getElementById('cfg-core-col-apraz').value,
        colDose24h: document.getElementById('cfg-core-col-dose-24h').value,
        colPeso: document.getElementById('cfg-core-col-peso').value,
        colAltura: document.getElementById('cfg-core-col-altura').value,
        colCreat: document.getElementById('cfg-core-col-creat').value,
        colProntDim:document.getElementById('cfg-core-col-pront-dim').value, 
        colNasc:document.getElementById('cfg-core-col-nasc').value, 
        colSexo:document.getElementById('cfg-core-col-sexo').value 
      },
      exames: { active:document.getElementById('card-exames').classList.contains('active'), aba:document.getElementById('cfg-ex-aba').value, colPront:document.getElementById('cfg-ex-col-pront').value, colNome:document.getElementById('cfg-ex-col-nome').value, colValor:document.getElementById('cfg-ex-col-valor').value, colData:document.getElementById('cfg-ex-col-data').value },
      rams: { active:document.getElementById('card-rams').classList.contains('active'), aba:document.getElementById('cfg-ram-aba').value, colGrav:document.getElementById('cfg-ram-col-grav').value, colCaus:document.getElementById('cfg-ram-col-caus').value }
    };
    
    const btn=document.querySelector('.config-sidebar .btn-save'); btn.innerHTML="<span>‚è≥</span> Salvando..."; btn.disabled=true;
    google.script.run.withSuccessHandler(r=>{
      btn.innerHTML="<span>üíæ</span> Salvar e Validar"; btn.disabled=false;
      if(r.sucesso){ globalConfig=cfg; updStat(r.status); alert("Salvo!"); } else alert(r.erro);
    }).apiSaveConfig(cfg);
  }

  function updStat(s) {
    const b=(id,on)=>{ const e=document.getElementById(id); e.className=on?'badge ready':'badge pending'; e.innerText=on?'ATIVO':'PENDENTE'; };
    b('st-core',s.hasCore); b('st-exames',s.hasExames); b('st-rams',s.hasRams);
    const l=(id,on)=>{ const e=document.getElementById('nav-'+id); e.disabled=!on; e.querySelector('.lock').style.display=on?'none':'inline'; };
    l('perfil',s.hasCore); l('eficacia',s.hasExames&&s.hasCore); l('seguranca',s.hasRams);
  }

  function importarRef(btn) { btn.innerText="..."; btn.disabled=true; google.script.run.withSuccessHandler(res => { btn.innerText="üì• Importar"; btn.disabled=false; alert(res.msg||res.erro); }).apiImportarReferencias(); }
  function processarExames(btn) { btn.innerText="..."; btn.disabled=true; google.script.run.withSuccessHandler(res => { btn.innerText="‚öôÔ∏è Processar"; btn.disabled=false; alert(res.msg||res.erro); }).apiProcessarAnaliseExames(); }

  function switchView(v, b) {
    if(v==='home') document.querySelector('main').scrollTop = 0;
    document.querySelectorAll('.view-section').forEach(e=>e.classList.remove('active'));
    document.getElementById('view-'+v).classList.add('active');
    document.querySelectorAll('.nav-btn').forEach(e=>e.classList.remove('active'));
    if(b) b.classList.add('active');
    if(v==='config') goToConfig();
    if(v==='perfil'||v==='eficacia') prepareFilters(v);
    if(v==='eficacia' && typeof initEficaciaModule === 'function') initEficaciaModule(globalConfig);
    if(v==='explorador' && typeof initExploradorModule === 'function') initExploradorModule();
    if(v==='fusao' && typeof initFusaoModule === 'function') initFusaoModule();
    setTimeout(()=>window.dispatchEvent(new Event('resize')),200);
  }
  function goToConfig() { document.getElementById('view-home').classList.remove('active'); document.getElementById('view-config').classList.add('active'); document.querySelectorAll('.nav-btn')[1].classList.add('active'); }
  function prepareFilters(v) { const c=globalConfig.core; if(!c)return; google.script.run.withSuccessHandler(l=>{ const s=document.getElementById('perf-med'); s.innerHTML=''; l.forEach(m=>s.innerHTML+=`<option value="${m}">${m}</option>`); }).apiGetMedicamentos(c.abaFatos, c.colMed); }
  function renderPerfil(){ /* ... */ } function renderSeguranca(){ /* ... */ }
</script>
</body>
</html>
