<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    /* =========================================
       1. DESIGN SYSTEM & VARI√ÅVEIS (PREMIUM UI)
       ========================================= */
    :root {
      --primary: #2563eb; --primary-dark: #1e40af; --accent: #3b82f6;
      --bg: #f8fafc; --surface: #ffffff; 
      --text: #0f172a; --text-light: #64748b;
      --border: #e2e8f0; --success: #10b981; --warning: #f59e0b; --danger: #ef4444;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -1px rgb(0 0 0 / 0.06);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -2px rgb(0 0 0 / 0.05);
    }

    * { box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

    /* =========================================
       2. CABE√áALHO (GLASSMORPHISM)
       ========================================= */
    header { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(226, 232, 240, 0.8); padding: 0 40px; height: 70px; display: flex; justify-content: space-between; align-items: center; z-index: 100; flex-shrink: 0; box-shadow: var(--shadow-sm); }
    .brand-area { display: flex; align-items: center; gap: 15px; }
    .logo { font-weight: 800; font-size: 1.4rem; background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; letter-spacing: -0.03em; display: flex; align-items: center; gap: 8px; }
    .study-badge { background: #eff6ff; color: #1e40af; padding: 6px 14px; border-radius: 20px; font-size: 0.8rem; font-weight: 700; border: 1px solid #bfdbfe; display: flex; align-items: center; gap: 8px; animation: slideInLeft 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: var(--shadow-sm); }
    @keyframes slideInLeft { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
    
    nav { display: flex; gap: 6px; background-color: #f1f5f9; padding: 6px; border-radius: 14px; border: 1px solid #e2e8f0; }
    .nav-btn { background: transparent; border: none; padding: 8px 18px; cursor: pointer; font-family: 'Inter', sans-serif; font-weight: 600; font-size: 0.85rem; color: #64748b; border-radius: 10px; transition: all 0.2s ease; display: flex; align-items: center; gap: 8px; }
    .nav-btn:hover:not(.active):not(:disabled) { background: rgba(255,255,255,0.8); color: var(--primary); }
    .nav-btn.active { background-color: #ffffff; color: var(--primary); box-shadow: var(--shadow-sm); transform: scale(1.02); }
    .nav-btn:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(100%); }
    .lock { font-size: 0.75em; opacity: 0.7; }

    /* =========================================
       3. VIEWS & ANIMA√á√ïES
       ========================================= */
    main { flex: 1; overflow: hidden; position: relative; opacity: 0; transition: opacity 0.6s ease-out; }
    body.loaded main { opacity: 1; }
    .view-section { display: none; width: 100%; height: 100%; overflow-y: auto; padding: 30px; box-sizing: border-box; animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
    .view-section.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

    /* =========================================
       4. HOME PAGE
       ========================================= */
    #view-home { padding: 0; }
    /* Hero */
    .hero-section { min-height: 85vh; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; background: radial-gradient(circle at 50% 50%, #1e293b 0%, #0f172a 100%); color: white; position: relative; overflow: hidden; }
    .hero-content { position: relative; z-index: 2; max-width: 800px; padding: 20px; }
    .hero-title { font-size: 4rem; font-weight: 800; margin-bottom: 20px; background: linear-gradient(to right, #ffffff 20%, #94a3b8 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; letter-spacing: -0.02em; }
    .hero-btn { padding: 18px 45px; font-size: 1.1rem; font-weight: 700; color: white; background: linear-gradient(135deg, var(--primary), #3b82f6); border: none; border-radius: 50px; cursor: pointer; box-shadow: 0 0 30px rgba(37,99,235,0.4), inset 0 1px 0 rgba(255,255,255,0.2); transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); position: relative; overflow: hidden; z-index: 2; }
    .hero-btn:hover { transform: scale(1.08) translateY(-2px); box-shadow: 0 0 50px rgba(37,99,235,0.6); }

    /* Hub */
    .hub-container { max-width: 1400px; margin: 40px auto; padding: 0 30px; display: none; animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1); }
    .hub-header { margin-bottom: 40px; display: flex; align-items: center; justify-content: space-between; }
    .hub-title { font-size: 2.5rem; font-weight: 800; color: #1e293b; display: flex; align-items: center; gap: 15px; }
    .hub-summary-box { background: linear-gradient(135deg, #eff6ff 0%, #f8fafc 100%); border: 1px solid #bfdbfe; border-radius: 12px; padding: 15px 20px; font-size: 1.05rem; color: #1e40af; font-weight: 500; display: inline-flex; align-items: center; gap: 10px; box-shadow: var(--shadow-sm); }
    
    .hub-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 30px; }
    .hub-card { background: #fff; border: 1px solid #e2e8f0; border-radius: 20px; padding: 30px; box-shadow: var(--shadow-md); transition: transform 0.3s ease; height: fit-content; }
    .hub-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }
    .hub-card h3 { margin: 0 0 25px 0; font-size: 1.2rem; color: #334155; display: flex; align-items: center; gap: 10px; font-weight: 800; letter-spacing: -0.01em; border-bottom: 2px solid #f1f5f9; padding-bottom: 15px; }

    /* Checklist */
    .checklist-container { display: flex; flex-direction: column; gap: 12px; }
    .check-btn { display: flex; align-items: center; gap: 18px; padding: 16px 20px; background: #fff; border: 1px solid #e2e8f0; border-radius: 12px; text-align: left; cursor: default; transition: all 0.3s; animation: fadeInItem 0.5s ease-out forwards; opacity: 0; position: relative; overflow: hidden; }
    .check-btn::before { content:''; position:absolute; left:0; top:0; bottom:0; width:6px; background:#cbd5e1; }
    .check-btn.ok::before { background: #10b981; } .check-btn.warn::before { background: #f59e0b; }
    .check-btn:hover { transform: translateX(5px); border-color: #cbd5e1; box-shadow: var(--shadow-md); }
    .check-icon { width: 36px; height: 36px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 1.2rem; background: #f1f5f9; color: #64748b; flex-shrink: 0; }
    .check-btn.ok .check-icon { background: #dcfce7; color: #166534; } .check-btn.warn .check-icon { background: #fef3c7; color: #b45309; }
    .check-content strong { display: block; font-size: 0.95rem; color: #1e293b; margin-bottom: 4px; } .check-content span { display: block; font-size: 0.85rem; color: #64748b; }
    
    @keyframes fadeInItem { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }

    .shortcut-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .hub-action-btn { padding: 20px; border: 1px solid #e2e8f0; border-radius: 16px; background: #fff; color: #475569; font-weight: 700; cursor: pointer; text-align: center; display: flex; flex-direction: column; align-items: center; gap: 10px; transition: all 0.2s; box-shadow: var(--shadow-sm); }
    .hub-action-btn:hover { border-color: var(--primary); background: #f8fafc; color: var(--primary); transform: translateY(-4px); box-shadow: var(--shadow-md); }
    .hub-action-btn span { font-size: 2rem; }

    /* =========================================
       5. CONFIG & OUTROS
       ========================================= */
    .config-container { display: grid; grid-template-columns: 1fr 340px; gap: 30px; max-width: 1400px; margin: 0 auto; }
    .module-card { background: #fff; border: 1px solid #e2e8f0; border-radius: 16px; margin-bottom: 25px; overflow: hidden; box-shadow: var(--shadow-sm); transition: border-color 0.3s; }
    .module-card.active { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(37,99,235,0.1); }
    .module-header { padding: 18px 25px; background: #f8fafc; font-weight: 700; color: #334155; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
    .module-body { padding: 25px; display: none; background: #fff; animation: slideDown 0.3s ease-out; }
    .module-card.active .module-body { display: block; }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
    .form-group label { display: block; font-size: 0.75rem; font-weight: 700; margin-bottom: 8px; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; }
    select, input { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; background: #f8fafc; font-size: 0.95rem; color: #1e293b; transition: 0.2s; box-sizing: border-box; }
    select:focus, input:focus { border-color: var(--primary); background: #fff; outline: none; box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }

    .btn-save { background: var(--primary); color: white; padding: 15px; border-radius: 10px; font-weight: 700; width: 100%; border: none; cursor: pointer; font-size: 1rem; display: flex; justify-content: center; align-items: center; gap: 10px; box-shadow: var(--shadow-md); transition: 0.2s; }
    .btn-save:hover { background: var(--primary-dark); transform: translateY(-2px); box-shadow: var(--shadow-lg); }
    .btn-outline { width: 100%; background: #fff; border: 1px solid #cbd5e1; color: #475569; padding: 12px; border-radius: 10px; font-weight: 600; cursor: pointer; font-size: 0.9rem; transition: 0.2s; margin-top: 10px; }
    .btn-outline:hover { border-color: var(--primary); color: var(--primary); background: #f0f9ff; }
    .status-card { background: #fff; padding: 25px; border-radius: 16px; border: 1px solid #e2e8f0; box-shadow: var(--shadow-sm); }

    /* =========================================
       6. EXPLORADOR (LATERAL)
       ========================================= */
    .exp-layout { display: grid; grid-template-columns: 300px 1fr; gap: 25px; height: 100%; max-width: 1600px; margin: 0 auto; }
    .exp-sidebar { background: #fff; border: 1px solid #e2e8f0; border-radius: 16px; padding: 25px; display: flex; flex-direction: column; gap: 15px; overflow-y: auto; box-shadow: var(--shadow-sm); }
    .exp-header { font-weight: 800; color: #1e293b; font-size: 1.2rem; border-bottom: 1px solid #f1f5f9; padding-bottom: 15px; margin-bottom: 5px; }
    .exp-ai-box { background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border: 1px solid #bfdbfe; padding: 15px; border-radius: 12px; display: flex; flex-direction: column; gap: 10px; }
    .exp-ai-label { font-size: 0.8rem; font-weight: 700; color: #1e40af; display:flex; align-items:center; gap:6px; }
    .exp-ai-btn { background: linear-gradient(135deg, #2563eb, #1d4ed8); color: white; border: none; padding: 10px; border-radius: 8px; font-weight: 700; font-size: 0.9rem; cursor: pointer; width: 100%; box-shadow: var(--shadow-sm); }
    .exp-chart-area { background: #fff; border: 1px solid #e2e8f0; border-radius: 16px; padding: 15px; box-shadow: var(--shadow-sm); position: relative; height: 100%; overflow: hidden; }
    .btn-plot { background: #10b981; color: white; border: none; padding: 14px; border-radius: 10px; font-weight: 700; cursor: pointer; width: 100%; margin-top: 15px; font-size: 1rem; display: flex; justify-content: center; align-items: center; gap: 8px; box-shadow: 0 4px 6px rgba(16, 185, 129, 0.2); transition: 0.2s; }
    .btn-plot:hover { background: #059669; transform: translateY(-2px); }

    /* =========================================
       7. WIZARD MODAL
       ========================================= */
    dialog#wizard-modal { padding: 0; border: none; border-radius: 24px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); max-width: 900px; width: 90%; background: #fff; animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); overflow: hidden; }
    @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    .wiz-content { padding: 50px; overflow-y: auto; max-height: 85vh; }
    .wiz-header { text-align: center; margin-bottom: 40px; }
    .wiz-title { font-size: 2rem; font-weight: 800; color: #1e293b; margin-bottom: 10px; }
    .wiz-upload-area { border: 2px dashed #cbd5e1; border-radius: 20px; padding: 50px; text-align: center; background: #f8fafc; cursor: pointer; transition: all 0.2s; margin: 25px 0; }
    .wiz-upload-area:hover { border-color: var(--primary); background: #eff6ff; transform: scale(1.01); }
    .file-list { margin-top: 20px; display: flex; flex-direction: column; gap: 10px; }
    .file-item { background: #fff; padding: 15px 20px; border: 1px solid #e2e8f0; border-radius: 12px; font-size: 0.95rem; display: flex; justify-content: space-between; align-items: center; box-shadow: var(--shadow-sm); }
    .btn-analyze { background: linear-gradient(135deg, #2563eb, #1e40af); color: white; width: 100%; padding: 18px; border-radius: 12px; border: none; font-weight: 700; font-size: 1.1rem; cursor: pointer; margin-top: 30px; display: none; transition: transform 0.2s; box-shadow: 0 10px 25px rgba(37, 99, 235, 0.3); }
    .btn-analyze:hover { transform: scale(1.02); box-shadow: 0 15px 35px rgba(37, 99, 235, 0.4); }
    .progress-container { margin-top: 30px; display: none; }
    .progress-bar { width: 100%; height: 12px; background: #e2e8f0; border-radius: 6px; overflow: hidden; box-shadow: inset 0 1px 2px rgba(0,0,0,0.1); }
    .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.5s ease-out; background-image: linear-gradient(45deg,rgba(255,255,255,.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,.15) 50%,rgba(255,255,255,.15) 75%,transparent 75%,transparent); background-size: 1rem 1rem; animation: loadingStripes 1s linear infinite; }
    @keyframes loadingStripes { from { background-position: 1rem 0; } to { background-position: 0 0; } }
    .ai-report-card { background: #fff; border: 1px solid #e2e8f0; border-radius: 16px; padding: 25px; margin-bottom: 20px; box-shadow: var(--shadow-sm); }
    .report-title { font-size: 0.85rem; font-weight: 800; color: #64748b; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px; }
    .report-item { display: flex; gap: 12px; align-items: flex-start; font-size: 1rem; color: #334155; margin-bottom: 12px; line-height: 1.6; }
  </style>
</head>
<body>

<?!= include('SplashScreen'); ?>

<header>
  <div class="brand-area">
    <div class="logo"><span>üöÄ</span> EUM Manager</div>
    <div id="study-badge-container"></div>
  </div>
  <nav>
    <button onclick="switchView('home')" class="nav-btn active">üè† In√≠cio</button>
    <button onclick="switchView('config')" class="nav-btn">‚öôÔ∏è Config</button>
    <div style="width:1px; height:24px; background:#cbd5e1; margin:0 5px;"></div>
    <button id="nav-eficacia" onclick="switchView('eficacia')" class="nav-btn" disabled>üß™ Efic√°cia <span class="lock">üîí</span></button>
    <button id="nav-seguranca" onclick="switchView('seguranca')" class="nav-btn" disabled>üõ°Ô∏è Seguran√ßa <span class="lock">üîí</span></button>
    <div style="width:1px; height:24px; background:#cbd5e1; margin:0 5px;"></div>
    <button class="nav-btn" onclick="switchView('explorador')">üß≠ Explorador</button>
    <button class="nav-btn" onclick="switchView('fusao')">‚öóÔ∏è Fus√£o</button>
  </nav>
</header>

<main>
  <section id="view-home" class="view-section active">
    <div class="hero-section" id="home-hero">
      <h1 class="hero-title">Intelig√™ncia Cl√≠nica</h1>
      <p style="color:#cbd5e1; margin-bottom:40px; font-size:1.3rem;">Importe seus protocolos e dados para come√ßar.</p>
      <button class="hero-btn" onclick="openWizard()">Iniciar Novo Estudo ‚ú®</button>
    </div>

    <div class="hub-container" id="home-hub" style="display:none;">
      <div class="hub-header">
        <div>
          <div class="hub-title"><span>üìä</span> Hub de Comando</div>
          <div class="hub-summary-box">
            <span style="font-size:1.2rem;">üìù</span>
            <span id="hub-summary">Carregando resumo...</span>
          </div>
        </div>
      </div>

      <div class="hub-grid">
        <div class="hub-card">
          <h3><span>üß†</span> Diagn√≥stico do Protocolo</h3>
          <div class="checklist-container" id="hub-checklist">
            <div style="color:#94a3b8; padding:40px; text-align:center; border:2px dashed #e2e8f0; border-radius:12px;">
              Sem diagn√≥stico recente.<br>Use a reconfigura√ß√£o para gerar.
            </div>
          </div>
        </div>

        <div style="display:flex; flex-direction:column; gap:25px;">
          <div class="hub-card">
            <h3><span>üöÄ</span> A√ß√µes R√°pidas</h3>
            <div class="shortcut-grid">
              <div class="hub-action-btn" onclick="switchView('eficacia')"><span>üß™</span><small>Efic√°cia</small></div>
              <div class="hub-action-btn" onclick="switchView('seguranca')"><span>üõ°Ô∏è</span><small>Seguran√ßa</small></div>
              <div class="hub-action-btn" onclick="switchView('explorador')"><span>üß≠</span><small>Explorador</small></div>
              <div class="hub-action-btn" onclick="openWizard()" style="color:#b45309;"><span>‚ôªÔ∏è</span><small>Reconfigurar</small></div>
            </div>
          </div>
          
          <div class="hub-card" style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border-color:#bfdbfe;">
            <h3 style="color:#1e40af; margin-bottom:15px; border-bottom:none;">üí° Dica Cl√≠nica</h3>
            <p style="font-size:0.9rem; color:#1e3a8a; margin:0; line-height:1.6;">
              Use o <b>Explorador</b> para criar colunas virtuais (TFG Renal, Dose/Kg) que n√£o existem na planilha original.
            </p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section id="view-config" class="view-section">
    <div class="config-container">
      <div>
        <h2 style="font-size:1.8rem; color:#1e293b; margin-bottom:25px;">Configura√ß√£o do Estudo</h2>
        <div class="module-card mandatory active" id="card-core">
          <div class="module-header"><div class="module-title">1. N√∫cleo & Posologia</div></div>
          <div class="module-body">
            <div class="form-grid">
              <div><label>Aba Eventos</label><select id="cfg-core-aba-fatos" class="sheet-selector" onchange="loadCols(this.value, 'core-fatos')"></select></div>
              <div><label>Aba Pacientes</label><select id="cfg-core-aba-dim" class="sheet-selector" onchange="loadCols(this.value, 'core-dim')"></select></div>
            </div>
            <div class="form-grid">
              <div><label>Prontu√°rio (Fatos)</label><select id="cfg-core-col-pront-fatos" class="col-core-fatos"></select></div>
              <div><label>Medicamento</label><select id="cfg-core-col-med" class="col-core-fatos"></select></div>
            </div>
            <hr style="border:0; border-top:1px solid #f1f5f9; margin:20px 0;">
            <div class="form-grid">
              <div><label>Data In√≠cio</label><select id="cfg-core-col-dt" class="col-core-fatos"></select></div>
              <div><label>Dose Unit</label><select id="cfg-core-col-dose-uni" class="col-core-fatos"></select></div>
            </div>
            <div class="form-grid">
              <div><label>Aprazamento</label><select id="cfg-core-col-apraz" class="col-core-fatos"></select></div>
              <div><label>Dose 24h</label><select id="cfg-core-col-dose-24h" class="col-core-fatos"></select></div>
            </div>
            <div class="form-grid">
              <div><label>Peso (kg)</label><select id="cfg-core-col-peso" class="col-core-fatos"></select></div>
              <div><label>Altura (cm)</label><select id="cfg-core-col-altura" class="col-core-fatos"></select></div>
              <div><label>Creatinina</label><select id="cfg-core-col-creat" class="col-core-fatos"></select></div>
            </div>
            <div class="form-grid">
              <div><label>Prontu√°rio (Dim)</label><select id="cfg-core-col-pront-dim" class="col-core-dim"></select></div>
              <div><label>Nasc</label><select id="cfg-core-col-nasc" class="col-core-dim"></select></div>
              <div><label>Sexo</label><select id="cfg-core-col-sexo" class="col-core-dim"></select></div>
            </div>
          </div>
        </div>
        <div class="module-card" id="card-exames">
          <div class="module-header" onclick="toggleModule('exames')">
            <div class="module-title">üß™ 2. Exames (Opcional)</div>
            <div class="toggle-switch"><div class="toggle-knob"></div></div>
          </div>
          <div class="module-body hidden-form" id="form-exames">
            <div class="form-group"><label>Aba Exames</label><select id="cfg-ex-aba" class="sheet-selector" onchange="loadCols(this.value, 'exames')"></select></div>
            <div class="form-grid" style="margin-top:15px;">
               <select id="cfg-ex-col-pront" class="col-exames"></select>
               <select id="cfg-ex-col-nome" class="col-exames"></select>
               <select id="cfg-ex-col-valor" class="col-exames"></select>
               <select id="cfg-ex-col-data" class="col-exames"></select>
            </div>
          </div>
        </div>
        <div class="module-card" id="card-rams">
          <div class="module-header" onclick="toggleModule('rams')">
            <div class="module-title">üõ°Ô∏è 3. Seguran√ßa (Opcional)</div>
            <div class="toggle-switch"><div class="toggle-knob"></div></div>
          </div>
          <div class="module-body hidden-form" id="form-rams">
             <div class="form-group"><label>Aba RAMs</label><select id="cfg-ram-aba" class="sheet-selector" onchange="loadCols(this.value, 'rams')"></select></div>
             <div class="form-grid" style="margin-top:15px;">
               <select id="cfg-ram-col-grav" class="col-rams"></select>
               <select id="cfg-ram-col-caus" class="col-rams"></select>
             </div>
          </div>
        </div>
      </div>
      <div class="config-sidebar">
        <button class="btn-save" onclick="saveCfg()"><span>üíæ</span> Salvar Configura√ß√£o</button>
        <hr style="border:0; border-top:1px solid #e2e8f0; margin:20px 0;">
        <button class="btn-outline" onclick="openRulesModal()">üìö Banco de Exames</button>
        <button class="btn-outline" onclick="openDoseModal()">üíä Banco de Doses</button>
        <div class="status-card" style="margin-top:20px;">
           <h4 style="margin:0 0 10px 0; font-size:0.95rem;">ü§ñ Modelos IA</h4>
           <button class="btn-outline" onclick="checkModelsIA(this)">üîç Listar Dispon√≠veis</button>
           <div id="model-list-result" style="font-size:0.75rem; margin-top:8px; display:none; background:#f1f5f9; padding:10px; border-radius:8px;"></div>
        </div>
        <div class="status-card" style="margin-top:20px; border: 2px dashed #f59e0b; background: #fffbeb;">
           <h4 style="margin:0; font-size:0.95rem; color:#b45309;">‚ö†Ô∏è Zona de Perigo</h4>
           <p style="font-size:0.85rem; color:#92400e; margin:10px 0; line-height:1.4;">Precisa corrigir o estudo ou come√ßar do zero?</p>
           <button class="btn-outline" style="width:100%; border-color:#f59e0b; color:#b45309; font-weight:700;" onclick="openWizard()">
             ‚ôªÔ∏è Reabrir Assistente IA
           </button>
        </div>
      </div>
    </div>
  </section>

  <section id="view-explorador" class="view-section">
    <div class="exp-layout">
      <div class="exp-sidebar">
        <div class="exp-header">üß≠ Explorador</div>
        <div class="exp-ai-box">
          <div class="exp-ai-label"><span>ü§ñ</span> Pergunte aos Dados</div>
          <input type="text" id="exp-ai-query" class="exp-ai-input" placeholder="Ex: Dose vs Peso?">
          <button class="exp-ai-btn" onclick="askExplorerAI()">‚ú® Analisar</button>
          <div id="exp-ai-feedback" class="ai-feedback" style="display:none; background:white; padding:10px; border-radius:8px; font-size:0.8rem; color:#2563eb; margin-top:10px;"></div>
        </div>
        <hr style="border:0; border-top:1px solid #f1f5f9; margin:15px 0;">
        <div class="exp-group">
          <label>1. Fonte</label>
          <select id="exp-source" class="exp-select sheet-selector" onchange="loadExplorerColumns()"></select>
        </div>
        <div class="exp-group">
          <label>2. Eixo X</label>
          <select id="exp-axis-x" class="exp-select"></select>
        </div>
        <div class="exp-group">
          <label>3. Eixo Y</label>
          <select id="exp-axis-y" class="exp-select"></select>
        </div>
        <div class="exp-group">
          <label>Gr√°fico</label>
          <select id="exp-chart-type" class="exp-select">
            <option value="bar">Barra</option>
            <option value="scatter">Dispers√£o</option>
            <option value="box">Boxplot</option>
            <option value="pie">Pizza</option>
          </select>
        </div>
        <button class="btn-plot" onclick="generateExplorerChart()">üöÄ Plotar Gr√°fico</button>
      </div>
      <div class="exp-chart-area">
        <div id="chart-explorer" style="width:100%; height:100%;"></div>
      </div>
    </div>
  </section>

  <?!= include('LabEficacia'); ?>
  <?!= include('LabReferencias'); ?>
  <?!= include('LabRegrasDose'); ?>
  <?!= include('LabFusao'); ?>
  <?!= include('LabSeguranca'); ?>

</main>

<dialog id="wizard-modal">
  <button class="wiz-close" onclick="document.getElementById('wizard-modal').close()">√ó</button>
  <div class="wiz-content">
    <div class="wiz-header">
      <div class="wiz-title">Configura√ß√£o Inteligente</div>
      <div class="wiz-subtitle">Arraste o PDF do Protocolo e a Planilha de Dados</div>
    </div>
    
    <div class="wiz-upload-area" id="drop-zone">
      <div style="font-size:3rem; margin-bottom:15px;">üìÇ</div>
      <div style="font-weight:600; color:#334155; font-size:1.1rem;">Arraste arquivos aqui</div>
      <div id="file-status-text" style="font-size:0.9rem; color:#64748b; margin-top:10px;">Aguardando PDF + Excel...</div>
      <input type="file" id="file-input" multiple accept=".pdf,.csv,.xlsx,.xls" style="display:none" onchange="handleFiles(this.files)">
    </div>
    
    <div id="file-list" class="file-list"></div>
    
    <button id="btn-analyze" class="btn-analyze" onclick="runAiAnalysis()">‚ú® Iniciar An√°lise</button>
    
    <div class="progress-container" id="wiz-progress">
      <div class="progress-bar"><div class="progress-fill" id="prog-fill"></div></div>
      <div class="progress-text">Processando com IA...</div>
    </div>

    <div id="ai-report-area" style="display:none; margin-top:30px;">
      <div class="ai-report-card" style="border-left: 5px solid #10b981;">
        <div class="report-title">‚úÖ Capacidades Detectadas</div>
        <ul class="report-list" id="list-capabilities"></ul>
      </div>
      <div class="ai-report-card" style="border-left: 5px solid #f59e0b;">
        <div class="report-title">‚ö†Ô∏è Pontos de Aten√ß√£o</div>
        <ul class="report-list" id="list-gaps"></ul>
      </div>
      <div style="text-align:center; margin-top:30px;">
        <div id="ai-summary-text" style="color:#64748b; font-size:1rem; margin-bottom:20px; font-style:italic;"></div>
        <button class="btn-save" style="max-width:350px; margin:0 auto; font-size:1.1rem; padding:18px;" onclick="confirmAiMapping()">üöÄ Aplicar Configura√ß√£o</button>
      </div>
    </div>
  </div>
</dialog>

<script>
  let globalConfig = {};
  let allSheets = [];
  let stateFiles = { pdf: null, matrix: null, fileName: null };
  let currentAiAnalysis = null;
  let currentMapping = null;

  // 1. INICIALIZA√á√ÉO
  window.onload = function() {
    // 1. Inicia Splash
    if (typeof startSplashSequence === 'function') {
      startSplashSequence((mode) => {
        // Ao clicar nos bot√µes, carrega a app
        document.body.classList.add('loaded'); // Libera a app
        if (mode === 'new') setTimeout(openWizard, 500);
      });
    }

    // 2. Carrega Dados
    google.script.run.withSuccessHandler(state => {
      initApp(state);
    }).apiGetInitialState();
  };

  function initApp(state) {
    if(!state) return;
    globalConfig = state.config || {};
    allSheets = state.sheets || [];
    refreshAllSheetSelectors();

    const isConfigured = state.status.hasCore;
    if (isConfigured) {
      document.getElementById('home-hero').style.display = 'none';
      document.getElementById('home-hub').style.display = 'block';
      renderHomeHub(globalConfig);
    } else {
      document.getElementById('home-hero').style.display = 'flex';
      document.getElementById('home-hub').style.display = 'none';
    }

    if(globalConfig.core) {
      const c = globalConfig.core;
      setVal('cfg-core-aba-fatos', c.abaFatos); setVal('cfg-core-aba-dim', c.abaDim);
      if(c.abaFatos) loadCols(c.abaFatos, 'core-fatos', () => fillCoreCols(c));
    }
    if(globalConfig.exames?.active) toggleModule('exames',true);
    if(globalConfig.rams?.active) toggleModule('rams',true);
    
    updStat(state.status);
  }

  function renderHomeHub(config) {
    if(config.studyName) document.getElementById('study-badge-container').innerHTML = `<div class="study-badge">üìÇ ${config.studyName}</div>`;
    document.getElementById('hub-summary').innerText = config.studySummary || "Estudo configurado.";
    const checkDiv = document.getElementById('hub-checklist');
    checkDiv.innerHTML = "";
    const analysis = config.aiAnalysis;
    if(analysis && analysis.capabilities) {
      analysis.capabilities.forEach((c,i) => checkDiv.innerHTML += `<div class="check-btn ok" style="animation-delay:${i*0.1}s"><div class="check-icon">‚úî</div><div class="check-content"><strong>Dispon√≠vel</strong><span>${c}</span></div></div>`);
      (analysis.gaps||[]).forEach((g,i) => checkDiv.innerHTML += `<div class="check-btn warn" style="animation-delay:${(i+2)*0.1}s"><div class="check-icon">!</div><div class="check-content"><strong>Aten√ß√£o</strong><span>${g}</span></div></div>`);
    } else {
      checkDiv.innerHTML = `<div style="padding:20px; text-align:center; color:#94a3b8;">Sem diagn√≥stico.<br>Reconfigure para gerar.</div>`;
    }
  }

  // UTILS
  function refreshAllSheetSelectors() {
    document.querySelectorAll('.sheet-selector').forEach(sel => {
      const cur = sel.value; sel.innerHTML = '<option value="">Selecione...</option>';
      allSheets.forEach(s => sel.innerHTML += `<option value="${s}">${s}</option>`);
      if(cur) sel.value = cur;
    });
  }
  function switchView(v) {
    document.querySelectorAll('.view-section').forEach(e=>e.classList.remove('active'));
    document.getElementById('view-'+v).classList.add('active');
    document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  }
  function setVal(id, v) { if(v) { const e = document.getElementById(id); if(e) e.value = v; } }
  function toggleModule(m, f) { const d=document.getElementById('card-'+m); if(f===true) d.classList.add('active'); else d.classList.toggle('active'); }
  function loadCols(s, c, cb) {
    if(!s) return;
    google.script.run.withSuccessHandler(cols => {
      document.querySelectorAll('.col-'+c).forEach(el => {
        const old = el.value; el.innerHTML = '<option value="">Selecione...</option>';
        cols.forEach(o => el.innerHTML += `<option value="${o}">${o}</option>`);
        if(old) el.value = old;
      });
      if(cb) cb();
    }).apiGetColumns(s);
  }
  function fillCoreCols(map) {
    setVal('cfg-core-col-pront-fatos', map.colProntFatos); setVal('cfg-core-col-med', map.colMed);
    setVal('cfg-core-col-dt', map.colDtIni); setVal('cfg-core-col-dose-uni', map.colDoseUni);
    setVal('cfg-core-col-apraz', map.colApraz); setVal('cfg-core-col-dose-24h', map.colDose24h);
    setVal('cfg-core-col-peso', map.colPeso); setVal('cfg-core-col-altura', map.colAltura);
    setVal('cfg-core-col-creat', map.colCreat); setVal('cfg-core-col-pront-dim', map.colProntDim);
    setVal('cfg-core-col-nasc', map.colNasc); setVal('cfg-core-col-sexo', map.colSexo);
  }
  function updStat(s) {
    document.getElementById('nav-eficacia').disabled = !s.hasCore;
    document.getElementById('nav-seguranca').disabled = !s.hasCore;
  }

  // WIZARD
  function openWizard() { document.getElementById('wizard-modal').showModal(); resetWizardUI(); }
  function resetWizardUI() {
    document.getElementById('ai-report-area').style.display='none';
    document.getElementById('wiz-progress').style.display='none';
    document.getElementById('btn-analyze').style.display='none';
    document.getElementById('file-list').innerHTML = "";
    stateFiles = { pdf: null, matrix: null, fileName: null };
  }
  const dropZone = document.getElementById('drop-zone');
  dropZone.onclick = () => document.getElementById('file-input').click();
  dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.style.background='#eff6ff'; });
  
  function handleFiles(files) {
    Array.from(files).forEach(f => {
      const n = f.name.toLowerCase();
      if(n.endsWith('.pdf')) {
        const r = new FileReader(); r.onload=e=>{ stateFiles.pdf=e.target.result.split(',')[1]; addFileUI(f.name, 'pdf'); checkReady(); }; r.readAsDataURL(f);
      } else if (n.match(/\.(xlsx|csv)$/)) {
        stateFiles.fileName = f.name;
        const r = new FileReader(); r.onload=e=>{
           const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
           stateFiles.matrix = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1});
           addFileUI(f.name, 'data'); checkReady(); 
        }; r.readAsArrayBuffer(f);
      }
    });
  }
  function addFileUI(name, type) {
    let icon = type==='pdf'?'üìÑ':'üìä';
    document.getElementById('file-list').innerHTML += `<div class="file-item"><span>${icon} ${name}</span><span style="color:#10b981">‚úî</span></div>`;
  }
  function checkReady() { if (stateFiles.pdf && stateFiles.matrix) document.getElementById('btn-analyze').style.display = 'block'; }

  function runAiAnalysis() {
    document.getElementById('wiz-progress').style.display='block';
    document.getElementById('btn-analyze').style.display='none';
    const bar = document.querySelector('.progress-fill');
    bar.style.width = "30%"; setTimeout(()=>bar.style.width="70%", 3000);

    google.script.run.withSuccessHandler(res => {
      bar.style.width = "100%"; setTimeout(() => document.getElementById('wiz-progress').style.display='none', 500);
      if(res.erro) return alert(res.erro);

      if(res.createdSheet && !allSheets.includes(res.createdSheet)) {
        allSheets.unshift(res.createdSheet); refreshAllSheetSelectors();
      }
      globalConfig.studyName = res.studyName;
      globalConfig.studySummary = res.studySummary;
      globalConfig.aiAnalysis = res.analysis;
      currentMapping = res.mapping || {};
      currentMapping.targetSheet = res.createdSheet; 
      currentAiAnalysis = res.analysis;

      const cap = document.getElementById('list-capabilities'); const gap = document.getElementById('list-gaps');
      cap.innerHTML=''; gap.innerHTML='';
      (res.analysis.capabilities||[]).forEach(t => cap.innerHTML+=`<li class="report-item"><span class="icon-check">‚úî</span> ${t}</li>`);
      (res.analysis.gaps||[]).forEach(t => gap.innerHTML+=`<li class="report-item"><span class="icon-warn">‚ö†Ô∏è</span> ${t}</li>`);
      
      document.getElementById('ai-summary-text').innerText = res.studySummary;
      document.getElementById('ai-report-area').style.display='block';
    }).apiMagicSetup(stateFiles.pdf, stateFiles.matrix, stateFiles.fileName);
  }

  function confirmAiMapping() {
    document.getElementById('wizard-modal').close();
    switchView('config');
    if(currentMapping) {
      const m = currentMapping;
      document.getElementById('cfg-core-aba-fatos').value = m.targetSheet;
      loadCols(m.targetSheet, 'core-fatos', () => {
         fillCoreCols({ colProntFatos: m.colProntFatos, colMed: m.colMed, colDtIni: m.colDtIni, colDoseUni: m.colDoseUni, colApraz: m.colApraz, colDose24h: m.colDose24h, colPeso: m.colPeso, colAltura: m.colAltura, colCreat: m.colCreat, colProntDim: m.colProntDim, colNasc: m.colNasc, colSexo: m.colSexo });
         saveCfg(true); 
      });
    }
  }

  function saveCfg(autoRedirect) {
    const cfg={
      studyName: globalConfig.studyName || "Estudo",
      studySummary: globalConfig.studySummary,
      aiAnalysis: currentAiAnalysis || globalConfig.aiAnalysis,
      core: { abaFatos:document.getElementById('cfg-core-aba-fatos').value, abaDim:document.getElementById('cfg-core-aba-dim').value, colProntFatos:document.getElementById('cfg-core-col-pront-fatos').value, colMed:document.getElementById('cfg-core-col-med').value, colDtIni:document.getElementById('cfg-core-col-dt').value, colDoseUni: document.getElementById('cfg-core-col-dose-uni').value, colApraz: document.getElementById('cfg-core-col-apraz').value, colDose24h: document.getElementById('cfg-core-col-dose-24h').value, colPeso: document.getElementById('cfg-core-col-peso').value, colAltura: document.getElementById('cfg-core-col-altura').value, colCreat: document.getElementById('cfg-core-col-creat').value, colProntDim:document.getElementById('cfg-core-col-pront-dim').value, colNasc:document.getElementById('cfg-core-col-nasc').value, colSexo:document.getElementById('cfg-core-col-sexo').value },
      exames: { active:document.getElementById('card-exames').classList.contains('active'), aba:document.getElementById('cfg-ex-aba').value, colPront:document.getElementById('cfg-ex-col-pront').value, colNome:document.getElementById('cfg-ex-col-nome').value, colValor:document.getElementById('cfg-ex-col-valor').value, colData:document.getElementById('cfg-ex-col-data').value },
      rams: { active:document.getElementById('card-rams').classList.contains('active'), aba:document.getElementById('cfg-ram-aba').value, colGrav:document.getElementById('cfg-ram-col-grav').value, colCaus:document.getElementById('cfg-ram-col-caus').value }
    };
    google.script.run.withSuccessHandler(r=>{
      if(r.sucesso){ globalConfig = cfg; renderHomeHub(cfg); updStat(r.status); if(autoRedirect) { switchView('home'); alert("‚ú® Configura√ß√£o aplicada!"); } else alert("Salvo!"); } else alert(r.erro);
    }).apiSaveConfig(cfg);
  }

  // EXPLORADOR
  function loadExplorerColumns() {
    const sheet = document.getElementById('exp-source').value;
    const xSel = document.getElementById('exp-axis-x'), ySel = document.getElementById('exp-axis-y');
    if(!sheet) return;
    xSel.innerHTML = '<option>Carregando...</option>';
    google.script.run.withSuccessHandler(cols => {
      let opts = ''; cols.forEach(c => opts += `<option value="${c}">${c}</option>`);
      opts += `<option disabled>‚îÄ‚îÄ‚îÄ CALCULADOS ‚îÄ‚îÄ‚îÄ</option><option value="CALC_RENAL_TFG" style="color:blue;">‚ú® TFG Renal</option><option value="CALC_DOSE_KG" style="color:blue;">‚ú® Dose/Kg</option><option value="CALC_IDADE" style="color:blue;">‚ú® Idade</option>`;
      xSel.innerHTML = opts; ySel.innerHTML = '<option value="">(Contagem)</option>' + opts;
    }).apiGetColumns(sheet);
  }
  function generateExplorerChart() {
    const s=document.getElementById('exp-source').value, x=document.getElementById('exp-axis-x').value, y=document.getElementById('exp-axis-y').value, t=document.getElementById('exp-chart-type').value;
    if(!s || !x) return alert("Selecione Eixos");
    const btn = document.querySelector('.btn-plot'); const txt = btn.innerText; btn.innerText="‚è≥"; btn.disabled=true;
    google.script.run.withSuccessHandler(res => {
      btn.innerText = txt; btn.disabled = false;
      if(!res.sucesso) return alert(res.erro);
      const xV=res.dados.map(d=>d[x]), yV=y?res.dados.map(d=>d[y]):null;
      let data=[];
      if(!yV && t==='bar') { const c={}; xV.forEach(v=>{const k=Math.floor(v); c[k]=(c[k]||0)+1;}); data=[{x:Object.keys(c),y:Object.values(c),type:'bar'}]; }
      else data=[{x:xV,y:yV,type:t,mode:'markers'}];
      Plotly.newPlot('chart-explorer', data, {title:`${y||'Contagem'} por ${x}`, margin:{l:40,r:20,t:40,b:40}});
    }).apiGetRawExplorerData(s, y?[x,y]:[x]);
  }
  function askExplorerAI() {
    const q=document.getElementById('exp-ai-query').value, s=document.getElementById('exp-source').value;
    if(!s) return alert("Selecione fonte.");
    google.script.run.withSuccessHandler(res=>{ if(res.viavel) document.getElementById('exp-ai-feedback').innerText = "Sugest√£o: " + res.explicacao; }).apiInterpretarGraficoIA(q,[]);
  }
  
  function checkModelsIA(btn) { btn.innerText="..."; google.script.run.withSuccessHandler(res => { btn.innerText="ü§ñ Modelos IA"; alert(res.sucesso?res.modelos.join('\n'):res.erro); }).apiCheckGeminiModels(); }
  function openRulesModal() { document.getElementById('rules-modal').showModal(); loadReferencias(); }
  function openDoseModal() { document.getElementById('dose-modal').showModal(); loadRegrasDose(); }
</script>
</body>
</html>
