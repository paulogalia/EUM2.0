<style>
  /* LAYOUT PRINCIPAL: GRID LATERAL */
  .exp-layout { 
    display: grid; 
    grid-template-columns: 280px 1fr; /* Barra Lateral Fixa | Gr√°fico Fluido */
    gap: 20px; 
    height: 100%; 
    max-width: 1600px; 
    margin: 0 auto; 
    overflow: hidden;
  }
  
  /* BARRA LATERAL DE CONTROLO */
  .exp-sidebar { 
    background: #fff; 
    border: 1px solid #e2e8f0; 
    border-radius: 12px; 
    padding: 20px; 
    display: flex; 
    flex-direction: column; 
    gap: 15px; 
    overflow-y: auto; 
    box-shadow: var(--shadow-sm);
  }

  .exp-header { font-weight: 800; color: #1e293b; font-size: 1.1rem; border-bottom: 1px solid #f1f5f9; padding-bottom: 10px; margin-bottom: 5px; }

  /* √ÅREA DE IA (Compacta na Sidebar) */
  .exp-ai-box {
    background: #eff6ff; border: 1px solid #bfdbfe; padding: 10px; border-radius: 8px; 
    display: flex; flex-direction: column; gap: 8px;
  }
  .exp-ai-label { font-size: 0.75rem; font-weight: 700; color: #1e40af; display:flex; align-items:center; gap:5px; }
  .exp-ai-input {
    width: 100%; padding: 8px; border: 1px solid #dbeafe; border-radius: 6px; font-size: 0.85rem; color: #1e3a8a; box-sizing: border-box;
  }
  .exp-ai-btn {
    background: linear-gradient(135deg, #2563eb, #1d4ed8); color: white; border: none; padding: 8px;
    border-radius: 6px; font-weight: 600; font-size: 0.85rem; cursor: pointer; text-align: center; width: 100%;
  }
  .exp-ai-btn:hover { background: #1e40af; }

  /* CONTROLES MANUAIS */
  .exp-group { display: flex; flex-direction: column; gap: 4px; }
  .exp-group label { font-size: 0.75rem; font-weight: 700; color: #64748b; }
  .exp-select { width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; background-color: #f8fafc; font-size: 0.85rem; color: #334155; }
  .exp-select option.virtual { color: #7c3aed; font-weight: bold; background: #f5f3ff; }

  /* BOT√ïES DE A√á√ÉO */
  .btn-plot { background: #10b981; color: white; border: none; padding: 12px; border-radius: 8px; font-weight: 700; cursor: pointer; width: 100%; margin-top: 10px; display: flex; justify-content: center; align-items: center; gap: 8px; }
  .btn-plot:hover { background: #059669; }
  
  .btn-stack { background: white; border: 1px solid #cbd5e1; color: #475569; padding: 8px; border-radius: 8px; font-weight: 600; cursor: pointer; width: 100%; display: flex; justify-content: center; gap: 5px; font-size: 0.85rem; }
  .btn-stack:hover { border-color: #94a3b8; color: #1e293b; }

  /* √ÅREA DO GR√ÅFICO */
  .exp-chart-area { 
    background: #fff; border: 1px solid #e2e8f0; border-radius: 12px; padding: 10px; 
    box-shadow: var(--shadow-sm); position: relative; height: 100%; overflow: hidden;
  }

  /* Feedback IA */
  .ai-feedback { font-size: 0.75rem; color: #059669; background: #ecfdf5; padding: 8px; border-radius: 6px; display:none; border:1px solid #a7f3d0; margin-top:5px; }
</style>

<section id="view-explorador" class="view-section" style="padding: 20px; height: 100%; box-sizing: border-box;">
  <div class="exp-layout">
    
    <div class="exp-sidebar">
      <div class="exp-header">üß≠ Explorador</div>

      <div class="exp-ai-box">
        <div class="exp-ai-label"><span>ü§ñ</span> Pergunte aos Dados</div>
        <input type="text" id="exp-ai-query" class="exp-ai-input" placeholder="Ex: Dose por peso vs Idade?">
        <button class="exp-ai-btn" onclick="askExplorerAI()">‚ú® Analisar</button>
        <div id="exp-ai-feedback" class="ai-feedback"></div>
      </div>

      <hr style="border:0; border-top:1px solid #f1f5f9; margin:5px 0;">

      <div class="exp-group">
        <label>1. Fonte de Dados</label>
        <select id="exp-source" class="exp-select" onchange="loadExplorerColumns()"><option value="">Carregando...</option></select>
      </div>

      <div class="exp-group">
        <label>2. Eixo X (Agrupador)</label>
        <select id="exp-axis-x" class="exp-select" disabled><option>--</option></select>
      </div>

      <div class="exp-group">
        <label>3. Eixo Y (M√©trica)</label>
        <select id="exp-axis-y" class="exp-select" disabled onchange="toggleAggOptions()"><option value="">(Contagem)</option></select>
      </div>

      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
        <div class="exp-group" id="grp-agg" style="opacity:0.5; pointer-events:none;">
          <label>Opera√ß√£o</label>
          <select id="exp-agg" class="exp-select"><option value="count">Contar</option><option value="sum">Soma</option><option value="avg">M√©dia</option></select>
        </div>
        <div class="exp-group">
          <label>Gr√°fico</label>
          <select id="exp-chart-type" class="exp-select">
            <option value="bar">üìä Barra</option>
            <option value="line">üìà Linha</option>
            <option value="pie">ü•ß Pizza</option>
            <option value="scatter">üí† Dispers√£o</option>
            <option value="box">üì¶ Boxplot</option>
          </select>
        </div>
      </div>

      <button class="btn-plot" id="btn-gen-exp" onclick="generateExplorerChart()">üöÄ Plotar Gr√°fico</button>
      <button class="btn-stack" onclick="exportExplorerToStack()">‚û°Ô∏è Enviar p/ Fus√£o</button>

      <div style="margin-top:auto; background:#f8fafc; padding:10px; border-radius:6px; border:1px dashed #cbd5e1;">
        <div style="font-size:0.7rem; font-weight:bold; color:#64748b; margin-bottom:5px;">üí° RECEITAS √öTEIS:</div>
        <div style="font-size:0.7rem; color:#475569; line-height:1.4;">
          ‚Ä¢ <b>Renal (Histograma):</b> X=TFG(Calc), Y=(Vazio), Barra.<br>
          ‚Ä¢ <b>Dose vs Peso:</b> X=Peso, Y=Dose24h, Dispers√£o.<br>
          ‚Ä¢ <b>Ajuste Dose:</b> X=TFG(Calc), Y=Dose/Kg(Calc), Dispers√£o.
        </div>
      </div>
    </div>

    <div class="exp-chart-area">
      <div id="chart-explorer" style="width:100%; height:100%;"></div>
    </div>

  </div>
</section>

<script>
  let explorerCols = [];
  let currentExplorerData = null;

  // Init
  function initExploradorModule() {
    const sel = document.getElementById('exp-source');
    const coreSelect = document.getElementById('cfg-core-aba-fatos');
    // Pega a aba configurada no Core como padr√£o
    if(coreSelect && coreSelect.options.length > 0) {
      sel.innerHTML = '<option value="">Selecione...</option>';
      // Adiciona a aba do core primeiro (mais prov√°vel)
      const coreSheet = document.getElementById('cfg-core-aba-fatos').value;
      if(coreSheet) sel.innerHTML += `<option value="${coreSheet}" selected>‚òÖ ${coreSheet}</option>`;
      
      // Adiciona as outras
      for (let i = 0; i < coreSelect.options.length; i++) {
        const val = coreSelect.options[i].value;
        if(val && val !== coreSheet) sel.innerHTML += `<option value="${val}">${val}</option>`;
      }
      // Carrega colunas automaticamente se houver sele√ß√£o
      if(sel.value) loadExplorerColumns();
    }
  }

  // IA
  function askExplorerAI() {
    const query = document.getElementById('exp-ai-query').value;
    const sheet = document.getElementById('exp-source').value;
    if (!sheet) return alert("Selecione a Fonte de Dados primeiro.");
    if (!query) return;
    
    const btn = document.querySelector('.exp-ai-btn');
    const originalText = btn.innerText;
    btn.innerText = "‚è≥"; btn.disabled = true;

    if (explorerCols.length === 0) loadExplorerColumns(() => executeAiQuery(query, btn, originalText));
    else executeAiQuery(query, btn, originalText);
  }

  function executeAiQuery(query, btn, originalText) {
    const feedback = document.getElementById('exp-ai-feedback');
    
    google.script.run.withSuccessHandler(res => {
      btn.innerText = originalText; btn.disabled = false;
      if (res.erro) { alert(res.erro); return; }
      if (!res.viavel) { alert("IA: " + res.explicacao); return; }
      
      feedback.innerHTML = `üí° ${res.explicacao}`;
      feedback.style.display = 'block';
      
      const setSelect = (id, val) => {
         const el = document.getElementById(id);
         if (!val) { el.value = ""; return; }
         if (el.querySelector(`option[value="${val}"]`)) { el.value = val; return; }
         for (let i=0; i<el.options.length; i++) {
            if (el.options[i].text.includes(val) || el.options[i].value.includes(val)) { el.selectedIndex = i; return; }
         }
      };

      setSelect('exp-axis-x', res.config.x);
      setSelect('exp-axis-y', res.config.y);
      document.getElementById('exp-chart-type').value = res.config.type || 'bar';
      document.getElementById('exp-agg').value = res.config.aggregation || 'count';
      
      toggleAggOptions();
      generateExplorerChart();
      
    }).apiInterpretarGraficoIA(query, explorerCols);
  }

  // Fun√ß√µes Core
  function loadExplorerColumns(callback) {
    const sheet = document.getElementById('exp-source').value;
    const xSel = document.getElementById('exp-axis-x');
    const ySel = document.getElementById('exp-axis-y');
    const btn = document.getElementById('btn-gen-exp');

    if(!sheet) return;
    btn.innerText = "‚è≥ Carregando colunas..."; btn.disabled = true;
    
    google.script.run.withSuccessHandler(cols => {
      explorerCols = cols;
      const virtualCols = [
        {val: "CALC_RENAL_TFG", label: "‚ú® TFG Renal (Calc)"},
        {val: "CALC_DOSE_KG", label: "‚ú® Dose/Kg (Calc)"},
        {val: "CALC_IDADE", label: "‚ú® Idade (Calc)"}
      ];

      let opts = '';
      cols.forEach(c => opts += `<option value="${c}">${c}</option>`);
      opts += `<option disabled>‚îÄ‚îÄ‚îÄ CALCULADOS ‚îÄ‚îÄ‚îÄ</option>`;
      virtualCols.forEach(v => opts += `<option value="${v.val}" class="virtual">${v.label}</option>`);

      xSel.innerHTML = opts; xSel.disabled = false;
      ySel.innerHTML = '<option value="">(Nenhum - Contagem)</option>' + opts; ySel.disabled = false;
      
      btn.innerText = "üöÄ Plotar Gr√°fico"; btn.disabled = false;
      if(callback) callback();
    }).apiGetColumns(sheet);
  }

  function toggleAggOptions() {
    const yVal = document.getElementById('exp-axis-y').value;
    const aggDiv = document.getElementById('grp-agg');
    if(yVal) { aggDiv.style.opacity = '1'; aggDiv.style.pointerEvents = 'auto'; } 
    else { aggDiv.style.opacity = '0.5'; aggDiv.style.pointerEvents = 'none'; }
  }

  function generateExplorerChart() {
    const sheet = document.getElementById('exp-source').value;
    const xCol = document.getElementById('exp-axis-x').value;
    const yCol = document.getElementById('exp-axis-y').value;
    const aggType = document.getElementById('exp-agg').value;
    const chartType = document.getElementById('exp-chart-type').value;

    if(!sheet || !xCol) return alert("Selecione pelo menos a Fonte e o Eixo X.");
    
    const colsToFetch = [xCol];
    if(yCol) colsToFetch.push(yCol);
    // Tenta pegar ID para drilldown
    const idC = explorerCols.find(c => c.toUpperCase().includes('PRONT') || c.toUpperCase().includes('ID'));
    if(idC && !colsToFetch.includes(idC)) colsToFetch.push(idC);

    const btn = document.getElementById('btn-gen-exp');
    btn.innerText = "üîÑ Processando..."; btn.disabled = true;

    google.script.run.withSuccessHandler(res => {
      btn.innerText = "üöÄ Plotar Gr√°fico"; btn.disabled = false;
      if(!res.sucesso) return alert(res.erro);
      
      currentExplorerData = { raw: res.dados, x: xCol, y: yCol, idCol: idC }; 
      renderExplorerChart(res.dados, xCol, yCol, aggType, chartType);
    }).apiGetRawExplorerData(sheet, colsToFetch);
  }

  function renderExplorerChart(data, xKey, yKey, aggType, chartType) {
    const grouped = {};
    data.forEach(row => {
      let xVal = row[xKey];
      // Tratamento data
      if(xVal && typeof xVal === 'string' && xVal.match(/^\d{4}-\d{2}-\d{2}T/)) xVal = xVal.split('T')[0];
      
      // Arredondamento para Histogramas (se X for num√©rico e gr√°fico for barra/pizza)
      if (typeof xVal === 'number' && (chartType === 'bar' || chartType === 'pie')) {
         // Se for TFG ou Dose/Kg, arredonda para inteiros para agrupar melhor
         if(xKey.includes('CALC') || xKey.toUpperCase().includes('DOSE')) xVal = Math.floor(xVal);
      }

      const k = String(xVal);
      if(!grouped[k]) grouped[k] = [];
      let val = (yKey && row[yKey] !== undefined) ? row[yKey] : 1;
      grouped[k].push(val);
    });

    const xFinal = [], yFinal = [];
    Object.keys(grouped).forEach(k => {
      const vals = grouped[k];
      let res = 0;
      if(aggType === 'count') res = vals.length;
      else {
        const nums = vals.map(v => parseFloat(v) || 0);
        if(aggType === 'sum') res = nums.reduce((a,b)=>a+b, 0);
        else if(aggType === 'avg') res = nums.reduce((a,b)=>a+b, 0) / nums.length;
        else if(aggType === 'max') res = Math.max(...nums);
        else if(aggType === 'min') res = Math.min(...nums);
      }
      xFinal.push(k); yFinal.push(res);
    });

    const pairs = xFinal.map((e,i) => ({x: e, y: yFinal[i]}));
    // Sort num√©rico ou alfab√©tico
    pairs.sort((a,b) => {
        const na = parseFloat(a.x), nb = parseFloat(b.x);
        if(!isNaN(na) && !isNaN(nb)) return na - nb;
        return a.x.localeCompare(b.x);
    });

    const isVirtual = xKey.startsWith('CALC_');
    // Cores diferentes para dados reais vs calculados
    const color = isVirtual ? '#8b5cf6' : '#3b82f6'; 

    const trace = {
      x: pairs.map(p => p.x), y: pairs.map(p => p.y),
      type: chartType === 'scatter' ? 'scatter' : (chartType === 'pie' ? 'pie' : (chartType==='box'?'box':'bar')),
      mode: 'markers', // Default para scatter
      marker: { color: color, size: 8, opacity: 0.7 }, 
      name: yKey || 'Contagem'
    };
    
    if(chartType === 'line') trace.mode = 'lines+markers';
    if(chartType === 'pie') { trace.labels = trace.x; trace.values = trace.y; delete trace.x; delete trace.y; }

    // Boxplot precisa dos dados brutos, n√£o agrupados. 
    // Implementa√ß√£o simplificada: se for Box, usa dados brutos se poss√≠vel
    if(chartType === 'box') {
       trace.x = data.map(d => d[xKey]);
       trace.y = yKey ? data.map(d => d[yKey]) : null;
       // Boxplot geralmente inverte: X=Categoria, Y=Valor num√©rico
       // Se usu√°rio escolheu X=TFG e Y=Dose, boxplot quer Y=Dose agrupado por X
    }

    const xLabel = document.querySelector(`#exp-axis-x option[value="${xKey}"]`).text;
    const yLabel = yKey ? document.querySelector(`#exp-axis-y option[value="${yKey}"]`).text : 'Contagem';

    const layout = {
      title: { text: `<b>${yLabel}</b> por <b>${xLabel}</b>`, font: {size: 18} },
      xaxis: { title: xLabel, automargin: true, gridcolor: '#f1f5f9' }, 
      yaxis: { title: yLabel, gridcolor: '#f1f5f9' },
      template: 'plotly_white', 
      margin: { l: 60, r: 30, t: 60, b: 80 },
      paper_bgcolor: 'rgba(0,0,0,0)',
      plot_bgcolor: 'rgba(0,0,0,0)'
    };

    Plotly.newPlot('chart-explorer', [trace], layout, {responsive: true});
  }

  function exportExplorerToStack() {
    if(!currentExplorerData) return alert("Gere um gr√°fico primeiro.");
    if(!currentExplorerData.idCol) return alert("Sem Prontu√°rio nos dados para cruzamento.");
    
    const exportData = currentExplorerData.raw.map(d => ({
      prontuario: d[currentExplorerData.idCol],
      valX: d[currentExplorerData.x],
      valY: currentExplorerData.y ? d[currentExplorerData.y] : 1
    }));
    
    const xLabel = document.querySelector(`#exp-axis-x option[value="${currentExplorerData.x}"]`).text;
    const yLabel = currentExplorerData.y ? document.querySelector(`#exp-axis-y option[value="${currentExplorerData.y}"]`).text : 'Contagem';

    if(window.addToStack) {
        window.addToStack('Explorador', `${yLabel} vs ${xLabel}`, exportData, 'valY');
    } else {
        alert("Stack global n√£o encontrado.");
    }
  }
</script>
